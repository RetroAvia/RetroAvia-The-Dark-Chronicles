<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>RetroAvia - The Dark Chronicles</title>
    <style>
        /* Font Imports - Embedded per evitare errori CORS */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600&display=swap');
        
        /* Fallback fonts nel caso i Google Fonts non si carichino */
        @font-face {
            font-family: 'Orbitron-Fallback';
            src: local('Courier New'), local('monospace');
            font-weight: 400 900;
            font-display: swap;
        }
        
        @font-face {
            font-family: 'Rajdhani-Fallback';
            src: local('Arial'), local('Helvetica'), local('sans-serif');
            font-weight: 300 600;
            font-display: swap;
        }
        
        :root {
            --neon-blue: #00d4ff;
            --neon-purple: #8b5cf6;
            --neon-green: #00ff88;
            --neon-orange: #ff6b35;
            --neon-red: #ff3b3b;
            --neon-cyan: #00ffff;
            --neon-pink: #ff0080;
            --dark-bg: #0a0a0f;
            --dark-surface: #1a1a2e;
            --dark-accent: #16213e;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glow: 0 0 20px;
            --shadow-deep: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            backface-visibility: hidden;
        }

        body {
            background: var(--dark-bg);
            font-family: 'Rajdhani', 'Rajdhani-Fallback', Arial, sans-serif;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            position: relative;
            min-height: 100vh;
            min-height: 100dvh;
        }

        /* LOADING SCREEN */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-surface) 50%, var(--dark-accent) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .loading-logo {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            animation: logoGlow 2s ease-in-out infinite alternate;
        }

        .loading-progress {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
            border-radius: 2px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .loading-text {
            color: var(--neon-cyan);
            font-size: 1rem;
            font-weight: 600;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0% { text-shadow: 0 0 20px var(--neon-blue); }
            100% { text-shadow: 0 0 40px var(--neon-green), 0 0 60px var(--neon-blue); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* NASCONDI COMPLETAMENTE TUTTO IL CODICE VISIBILE */
        .screen:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .story-overlay:not(.active),
        .pause-overlay:not(.active),
        .overlay:not(.active) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Nascondi elementi del gioco quando non in game */
        body:not(.game-active) .game-ui,
        body:not(.game-active) .world,
        body:not(.game-active) .mobile-controls {
            display: none !important;
            visibility: hidden !important;
        }

        /* SUCCESS NOTIFICATION */
        .success-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.1rem;
            z-index: 5000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 50px var(--neon-green);
            animation: successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); }
            50% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        /* PROGRESS INDICATOR - SOLO DESKTOP */
        .progress-indicator {
            position: fixed;
            display: none;
            flex-direction: row;
            gap: 10px;
            z-index: 300;
            background: rgba(10, 10, 15, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--neon-blue);
            backdrop-filter: blur(10px);
        }

        /* MOSTRA SOLO SU DESKTOP */
        @media screen and (min-width: 1025px) {
            body.game-active .progress-indicator {
                display: flex;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* NASCOSTO SU TABLET E MOBILE */
        @media screen and (max-width: 1024px) {
            .progress-indicator {
                display: none !important;
            }
        }

        /* DASHBOARD MOBILE ORIZZONTALE - SISTEMA UNIVERSALE SICURO */
        .mobile-dashboard {
            position: absolute;
            top: env(safe-area-inset-top, 10px);
            left: env(safe-area-inset-left, 8px);
            right: env(safe-area-inset-right, 8px);
            display: none;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            z-index: 300;
            background: linear-gradient(90deg, 
                rgba(10, 10, 15, 0.95) 0%, 
                rgba(26, 26, 46, 0.9) 50%,
                rgba(10, 10, 15, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 0 0 20px 20px;
            padding: 8px 12px;
            border-bottom: 2px solid rgba(0, 212, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            height: 50px;
            max-height: 15vh; /* Sicurezza per non andare fuori schermo */
        }

        /* Mostra dashboard mobile solo su dispositivi touch */
        body.touch-device .mobile-dashboard {
            display: flex !important;
        }

        /* NASCODI DASHBOARD DESKTOP SU MOBILE E TABLET TOUCH */
        body.touch-device .futuristic-hud {
            display: none !important;
        }

        /* Eccezione per tablet in landscape dove la HUD pu√≤ essere utile */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            body.touch-device .futuristic-hud {
                display: block !important;
            }
            
            body.touch-device .mobile-dashboard {
                display: none !important;
            }
        }

        /* Dashboard mobile - stile delle metriche UNIVERSALE */
        .mobile-metric {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 6px 8px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: 45px;
            flex: 1;
            max-width: 65px;
        }

        .mobile-metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.7;
        }

        .mobile-metric-label {
            font-size: 0.55rem;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
            font-weight: 600;
            line-height: 1;
        }

        .mobile-metric-value {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.75rem;
            text-shadow: 0 0 8px currentColor;
            line-height: 1;
        }

        /* Colori specifici per le metriche mobile */
        .mobile-metric.score {
            color: var(--neon-green);
            border-color: rgba(0, 255, 136, 0.3);
        }

        .mobile-metric.time {
            color: var(--neon-cyan);
            border-color: rgba(0, 255, 255, 0.3);
        }

        .mobile-metric.crystals {
            color: var(--neon-purple);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .mobile-metric.energy {
            color: var(--neon-orange);
            border-color: rgba(255, 107, 53, 0.3);
        }

        /* Player info mobile UNIVERSALE COMPATTO */
        .mobile-player-info {
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.25) 0%, 
                rgba(139, 92, 246, 0.2) 100%);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 12px;
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 85px;
            max-width: 120px;
        }

        .mobile-avatar {
            width: 28px;
            height: 28px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.5);
            flex-shrink: 0;
        }

        .mobile-avatar::before {
            content: 'üöÄ';
        }

        .mobile-player-details {
            flex: 1;
            min-width: 0;
        }

        .mobile-player-name {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.65rem;
            color: var(--neon-blue);
            text-shadow: 0 0 6px var(--neon-blue);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
        }

        .mobile-player-level {
            font-size: 0.55rem;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1;
        }

        /* TUTORIAL OVERLAY */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-deep);
        }

        .tutorial-title {
            font-family: 'Orbitron', monospace;
            font-size: 1.8rem;
            color: var(--neon-green);
            margin-bottom: 20px;
        }

        .tutorial-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .tutorial-control {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .tutorial-key {
            display: inline-block;
            background: var(--neon-blue);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 700;
            margin-right: 10px;
        }

        /* SISTEMA RESPONSIVE UNIVERSALE - CONSERVATIVO PER TUTTI I TELEFONI */
        
        /* Mobile Small - Tutti i telefoni piccoli fino a 430px (iPhone 13 mini, Galaxy S, ecc.) */
        @media screen and (max-width: 430px) {
            body:not(.game-active) {
                overflow-y: auto;
                overflow-x: hidden;
                height: auto;
                min-height: 100vh;
            }
            
            body.game-active {
                overflow: hidden;
                height: 100vh;
                height: 100dvh;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
                position: relative;
                transform: scale(0.75);
                transform-origin: center center;
            }
            
            .world {
                width: 140vw;
                height: 100vh;
                height: 100dvh;
            }

            /* Dashboard universale compatta per tutti i telefoni */
            .mobile-dashboard {
                height: 45px !important;
                padding: 6px 10px !important;
                gap: 6px !important;
                top: max(env(safe-area-inset-top, 0px), 8px) !important;
            }

            /* Controlli universali compatti per tutti i telefoni */
            .control-btn {
                width: 55px !important;
                height: 55px !important;
                font-size: 1.2rem !important;
                border-width: 2px !important;
            }

            .mobile-controls {
                bottom: max(env(safe-area-inset-bottom, 0px), 15px) !important;
                left: max(env(safe-area-inset-left, 0px), 15px) !important;
                right: max(env(safe-area-inset-right, 0px), 15px) !important;
            }

            .control-group {
                gap: 20px !important;
            }

            /* Audio controls universali */
            body.touch-device .audio-controls {
                top: max(env(safe-area-inset-top, 0px), 55px) !important;
                right: max(env(safe-area-inset-right, 0px), 8px) !important;
            }

            body.touch-device .audio-btn, 
            body.touch-device .quality-btn {
                min-width: 28px !important;
                height: 28px !important;
                font-size: 0.7rem !important;
            }

            /* MENU PRINCIPALE universale */
            .main-menu-container {
                padding: 15px 20px !important;
                min-height: 100vh !important;
                min-height: 100dvh !important;
                justify-content: flex-start !important;
                padding-top: max(env(safe-area-inset-top, 0px), 20px) !important;
                overflow-y: auto !important;
            }

            .retro-logo {
                font-size: 2.2rem !important;
                margin-bottom: 8px !important;
                line-height: 1.1 !important;
            }

            .dark-chronicles {
                font-size: 0.7rem !important;
                margin-bottom: 15px !important;
            }

            .briefing-intro {
                font-size: 0.8rem !important;
                line-height: 1.4 !important;
                margin-bottom: 20px !important;
            }

            .mission-cards {
                gap: 10px !important;
                margin: 15px 0 !important;
            }

            .mission-card {
                padding: 12px !important;
                min-height: auto !important;
            }

            .player-input-section {
                margin-top: 20px !important;
            }

            .futuristic-input {
                max-width: 280px !important;
                padding: 10px 15px !important;
                font-size: 0.9rem !important;
            }

            .launch-button {
                min-width: 180px !important;
                padding: 10px 25px !important;
                font-size: 0.9rem !important;
            }
        }

        /* Mobile Medium - Telefoni medi da 431px a 600px (iPhone 14, Galaxy S23, Pixel, ecc.) */
        @media screen and (min-width: 431px) and (max-width: 600px) {
            body:not(.game-active) {
                overflow-y: auto;
                overflow-x: hidden;
                height: auto;
                min-height: 100vh;
            }
            
            body.game-active {
                overflow: hidden;
                height: 100vh;
                height: 100dvh;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
                position: relative;
                transform: scale(0.8);
                transform-origin: center center;
            }
            
            .world {
                width: 130vw;
                height: 100vh;
                height: 100dvh;
            }

            /* Dashboard media per telefoni medi */
            .mobile-dashboard {
                height: 48px !important;
                padding: 8px 12px !important;
                gap: 8px !important;
                top: max(env(safe-area-inset-top, 0px), 10px) !important;
            }

            /* Controlli medi per telefoni medi */
            .control-btn {
                width: 60px !important;
                height: 60px !important;
                font-size: 1.3rem !important;
                border-width: 2px !important;
            }

            .mobile-controls {
                bottom: max(env(safe-area-inset-bottom, 0px), 18px) !important;
                left: max(env(safe-area-inset-left, 0px), 18px) !important;
                right: max(env(safe-area-inset-right, 0px), 18px) !important;
            }

            .control-group {
                gap: 25px !important;
            }

            /* Audio controls medi */
            body.touch-device .audio-controls {
                top: max(env(safe-area-inset-top, 0px), 60px) !important;
                right: max(env(safe-area-inset-right, 0px), 10px) !important;
            }

            body.touch-device .audio-btn, 
            body.touch-device .quality-btn {
                min-width: 30px !important;
                height: 30px !important;
                font-size: 0.75rem !important;
            }

            /* MENU PRINCIPALE medio */
            .main-menu-container {
                padding: 18px 22px !important;
                min-height: 100vh !important;
                min-height: 100dvh !important;
                justify-content: flex-start !important;
                padding-top: max(env(safe-area-inset-top, 0px), 22px) !important;
                overflow-y: auto !important;
            }

            .retro-logo {
                font-size: 2.5rem !important;
                margin-bottom: 10px !important;
                line-height: 1.1 !important;
            }

            .dark-chronicles {
                font-size: 0.75rem !important;
                margin-bottom: 16px !important;
            }

            .briefing-intro {
                font-size: 0.82rem !important;
                line-height: 1.5 !important;
            }
        }

        /* Mobile Large - Telefoni grandi e phablet da 601px a 767px */
        @media screen and (min-width: 601px) and (max-width: 767px) {
            body:not(.game-active) {
                overflow-y: auto;
                overflow-x: hidden;
                height: auto;
                min-height: 100vh;
            }
            
            body.game-active {
                overflow: hidden;
                height: 100vh;
                height: 100dvh;
            }
            
            .game-container {
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
                position: relative;
                transform: scale(0.85);
                transform-origin: center center;
            }
            
            .world {
                width: 125vw;
                height: 100vh;
                height: 100dvh;
            }

            /* Dashboard grande per phablet */
            .mobile-dashboard {
                height: 52px !important;
                padding: 10px 14px !important;
                gap: 10px !important;
                top: max(env(safe-area-inset-top, 0px), 12px) !important;
            }

            /* Controlli grandi per phablet */
            .control-btn {
                width: 65px !important;
                height: 65px !important;
                font-size: 1.4rem !important;
                border-width: 2.5px !important;
            }

            .mobile-controls {
                bottom: max(env(safe-area-inset-bottom, 0px), 20px) !important;
                left: max(env(safe-area-inset-left, 0px), 20px) !important;
                right: max(env(safe-area-inset-right, 0px), 20px) !important;
            }

            .control-group {
                gap: 30px !important;
            }

            /* Audio controls grandi */
            body.touch-device .audio-controls {
                top: max(env(safe-area-inset-top, 0px), 65px) !important;
                right: max(env(safe-area-inset-right, 0px), 12px) !important;
            }

            body.touch-device .audio-btn, 
            body.touch-device .quality-btn {
                min-width: 32px !important;
                height: 32px !important;
                font-size: 0.8rem !important;
            }

            /* MENU PRINCIPALE grande */
            .main-menu-container {
                padding: 20px 25px !important;
                min-height: 100vh !important;
                min-height: 100dvh !important;
                justify-content: flex-start !important;
                padding-top: max(env(safe-area-inset-top, 0px), 25px) !important;
                overflow-y: auto !important;
            }

            .retro-logo {
                font-size: 3rem !important;
                margin-bottom: 12px !important;
                line-height: 1.2 !important;
            }

            .dark-chronicles {
                font-size: 0.9rem !important;
                margin-bottom: 18px !important;
            }

            .briefing-intro {
                font-size: 0.9rem !important;
                line-height: 1.5 !important;
            }
        }

        /* Tablet Portrait - OTTIMIZZATO con posizionamento intelligente */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .game-container {
                transform: scale(0.85);
                transform-origin: center center;
            }
            
            .world {
                width: 120vw;
            }
            
            /* HUD pi√π compatto sui tablet */
            .futuristic-hud {
                height: 45px;
                padding: 3px 6px;
                top: 0;
                position: fixed; /* Fixed per evitare problemi di scroll */
            }

            .hud-layout {
                grid-template-columns: 180px 1fr auto auto 160px;
                padding: 3px 6px;
                gap: 6px;
                height: 100%;
                align-items: center;
            }

            /* Player panel pi√π compatto */
            .player-panel {
                padding: 6px 10px;
            }

            .player-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }

            .player-name {
                font-size: 0.75rem;
            }

            .player-level {
                font-size: 0.6rem;
            }

            /* Metriche pi√π compatte */
            .metric-card {
                padding: 4px 8px;
                min-width: 60px;
            }

            .metric-label {
                font-size: 0.55rem;
            }

            .metric-value {
                font-size: 0.75rem;
            }

            /* Energy system pi√π compatto */
            .energy-system {
                padding: 6px 10px;
                gap: 6px;
            }

            .energy-icon {
                width: 22px;
                height: 22px;
                font-size: 10px;
            }

            .energy-label {
                font-size: 0.55rem;
            }

            .energy-orb {
                width: 10px;
                height: 10px;
            }

            /* Controlli pi√π piccoli */
            .neo-btn {
                padding: 6px 8px;
                font-size: 0.6rem;
                min-width: 35px;
            }

            .control-btn {
                width: 70px; /* Tablet Portrait */
                height: 70px;
                font-size: 1.6rem;
            }
        }

        /* Tablet Landscape - OTTIMIZZATO con posizionamento intelligente */
        @media screen and (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .game-container {
                transform: scale(0.95);
                transform-origin: center center;
            }
            
            .world {
                width: 110vw;
            }

            /* HUD ottimizzato per landscape */
            .futuristic-hud {
                height: 55px;
                padding: 6px 10px;
                top: 0;
                position: fixed; /* Fixed per evitare problemi di scroll */
            }

            .hud-layout {
                grid-template-columns: 200px 1fr auto auto auto 180px;
                padding: 6px 10px;
                gap: 8px;
                height: 100%;
                align-items: center;
            }

            .control-btn {
                width: 65px; /* Tablet Landscape */
                height: 65px;
                font-size: 1.5rem;
            }
        }

        /* Desktop */
        @media screen and (min-width: 1025px) {
            .game-container {
                transform: none;
            }
            
            .world {
                width: 2000px;
            }
            
            /* Su desktop i controlli sono generalmente pi√π piccoli e precisi */
            .control-btn {
                width: 70px !important; /* Forza la dimensione per desktop */
                height: 70px !important;
                font-size: 1.6rem !important;
            }
        }

        /* Adaptive Quality - Riduce effetti su device lenti */
        @media (max-width: 480px), (max-height: 600px) {
            .energy-wave {
                animation: none;
            }
            
            .background-layer {
                opacity: 0.1;
            }
            
            * {
                will-change: auto;
            }
            
            .collectible {
                animation-duration: 4s;
            }
            
            .enemy {
                animation-duration: 3s;
            }
        }

        /* SISTEMA DI POSIZIONAMENTO MOBILE CONTROLS INTELLIGENTE */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: none;
            justify-content: space-between;
            align-items: center;
            pointer-events: all;
            z-index: 200;
        }

        /* Mostrati quando √® attiva la classe .touch-device */
        body.touch-device .mobile-controls {
            display: flex !important;
        }

        /* SISTEMA DI POSIZIONAMENTO AUDIO INTELLIGENTE UNIVERSALE */
        .audio-controls {
            position: absolute;
            pointer-events: all;
            z-index: 350;
            display: flex;
            bottom: 15px;
            left: 15px;
            gap: 8px;
            transition: all 0.3s ease;
        }

        /* Su mobile, posiziona i controlli audio in modo sicuro */
        body.touch-device .audio-controls {
            top: calc(env(safe-area-inset-top, 0px) + 55px);
            right: calc(env(safe-area-inset-right, 0px) + 8px);
            left: auto;
            bottom: auto;
            flex-direction: row;
            gap: 4px;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            padding: 3px;
            border: 1px solid rgba(0, 212, 255, 0.25);
            max-width: 80px;
        }

        /* Controlli audio mobile universali e compatti */
        body.touch-device .audio-btn, 
        body.touch-device .quality-btn {
            min-width: 28px !important;
            height: 28px !important;
            font-size: 0.7rem !important;
            border-width: 1px !important;
            background: rgba(255, 255, 255, 0.08) !important;
            backdrop-filter: blur(5px) !important;
            border-radius: 4px !important;
            padding: 4px !important;
        }

        /* Animated Background */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-surface) 50%, var(--dark-accent) 100%);
            z-index: -2;
        }

        .background-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            will-change: transform;
        }

        .stars {
            background: transparent;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            will-change: transform;
        }

        .energy-wave {
            position: absolute;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, transparent 50%, rgba(0, 212, 255, 0.01) 70%, transparent 90%);
            animation: waveRotate 40s linear infinite;
            will-change: transform;
        }

        /* Qualit√† bassa - animazioni ridotte */
        .low-quality .energy-wave {
            animation: none;
        }

        .low-quality .collectible {
            animation-duration: 6s;
        }

        .low-quality .enemy {
            animation-duration: 4s;
        }

        .low-quality .background-layer {
            opacity: 0.1;
        }

        .low-quality .star {
            display: none;
        }

        @keyframes waveRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Menu System */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }

        .screen.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        /* MENU PRINCIPALE OTTIMIZZATO */
        .main-menu-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(
                135deg,
                rgba(10, 10, 15, 0.95) 0%,
                rgba(26, 26, 46, 0.9) 30%,
                rgba(139, 92, 246, 0.1) 60%,
                rgba(0, 212, 255, 0.05) 100%
            );
            backdrop-filter: blur(15px);
        }

        .main-menu-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Ccircle cx='30' cy='30' r='1'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            animation: matrixRain 20s linear infinite;
            z-index: -1;
        }

        @keyframes matrixRain {
            0% { transform: translateY(-60px); }
            100% { transform: translateY(60px); }
        }

        /* Logo compatto - FIX UNIVERSALE PER TUTTI I MOBILE */
        .retro-logo {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: clamp(2.2rem, 5vw, 4rem);
            font-weight: 900;
            text-align: center;
            margin-bottom: 15px;
            position: relative;
            z-index: 10;
            line-height: 1.1;
            overflow: visible;
            word-break: keep-all;
            white-space: nowrap;
        }

        /* Assicura che il logo non venga mai tagliato su mobile */
        @media screen and (max-width: 767px) {
            .retro-logo {
                font-size: clamp(1.8rem, 8vw, 3rem) !important;
                margin-bottom: 10px !important;
                line-height: 1 !important;
                padding: 0 10px !important;
            }
            
            .dark-chronicles {
                font-size: clamp(0.7rem, 3vw, 1rem) !important;
                margin-bottom: 15px !important;
            }
            
            /* Menu principale responsive per tutti i mobile */
            .main-menu-container {
                padding: 15px 20px !important;
                min-height: 100vh !important;
                min-height: 100dvh !important;
                justify-content: flex-start !important;
                padding-top: 20px !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
        }

        .retro-logo .retro-text {
            background: linear-gradient(
                45deg,
                var(--neon-blue) 0%,
                var(--neon-cyan) 25%,
                var(--neon-purple) 50%,
                var(--neon-pink) 75%,
                var(--neon-green) 100%
            );
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: logoGradient 4s ease-in-out infinite;
            text-shadow: 
                0 0 30px rgba(0, 212, 255, 0.5),
                0 0 60px rgba(139, 92, 246, 0.3),
                0 0 90px rgba(0, 255, 136, 0.2);
        }

        .dark-chronicles {
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            color: var(--neon-orange);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--neon-orange);
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes logoGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes titlePulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }

        /* Mission briefing compatto */
        .mission-briefing {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .briefing-intro {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 25px;
            animation: fadeInUp 1s ease-out 0.5s both;
        }

        .mission-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .mission-card {
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0.05) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 1s ease-out both;
        }

        .mission-card:nth-child(1) { animation-delay: 0.7s; }
        .mission-card:nth-child(2) { animation-delay: 0.9s; }
        .mission-card:nth-child(3) { animation-delay: 1.1s; }

        .mission-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-blue);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(0, 212, 255, 0.2);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .card-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--neon-blue);
        }

        .card-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .objective-card { color: var(--neon-green); }
        .controls-card { color: var(--neon-cyan); }
        .rewards-card { color: var(--neon-purple); }

        /* Input section compatto */
        .player-input-section {
            margin-top: 25px;
            text-align: center;
        }

        .input-label {
            font-family: 'Orbitron', monospace;
            font-size: 0.9rem;
            color: var(--neon-blue);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeInUp 1s ease-out 1.3s both;
        }

        .futuristic-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            color: white;
            padding: 12px 20px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            width: 100%;
            max-width: 350px;
            margin: 0 auto 15px;
            outline: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            animation: fadeInUp 1s ease-out 1.5s both;
        }

        .futuristic-input:focus {
            border-color: var(--neon-blue);
            box-shadow: 
                0 0 20px rgba(0, 212, 255, 0.3),
                inset 0 0 15px rgba(0, 212, 255, 0.1);
            transform: scale(1.02);
        }

        .futuristic-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }

        .launch-button {
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            border: none;
            color: white;
            padding: 12px 30px;
            font-family: 'Orbitron', monospace;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 12px;
            min-width: 220px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeInUp 1s ease-out 1.7s both;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.3),
                0 0 15px rgba(0, 255, 136, 0.3);
        }

        .launch-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .launch-button:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.4),
                0 0 30px rgba(0, 255, 136, 0.5);
        }

        .launch-button:hover::before {
            left: 100%;
        }

        .launch-button:active {
            transform: translateY(-1px) scale(1.01);
            transition: transform 0.1s ease;
        }

        /* Enhanced Message System */
        .enhanced-message {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.95), 
                rgba(255, 59, 59, 0.95));
            backdrop-filter: blur(15px);
            border: 2px solid var(--neon-orange);
            border-radius: 12px;
            color: white;
            padding: 15px 25px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            z-index: 600;
            animation: enhancedMessageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(255, 107, 53, 0.4);
            max-width: 350px;
            text-align: center;
        }

        .enhanced-message::before {
            content: '‚ö†Ô∏è';
            font-size: 1.2rem;
            margin-right: 8px;
        }

        @keyframes enhancedMessageSlide {
            from { 
                transform: translateX(-50%) translateY(-20px); 
                opacity: 0; 
                scale: 0.9;
            }
            to { 
                transform: translateX(-50%) translateY(0); 
                opacity: 1; 
                scale: 1;
            }
        }

        .btn {
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple));
            border: none;
            color: white;
            padding: 12px 25px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            margin: 6px;
            min-width: 180px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow) var(--neon-blue);
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Story Overlay */
        .story-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 10, 15, 0.95), rgba(26, 26, 46, 0.95));
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .story-overlay.active {
            display: flex;
            opacity: 1;
        }

        .story-content {
            max-width: 700px;
            width: 90%;
            text-align: center;
            padding: 30px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            box-shadow: var(--shadow-deep), var(--glow) rgba(0, 212, 255, 0.2);
        }

        .story-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--glow) var(--neon-green);
        }

        .story-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Game Canvas */
        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: transparent;
            overflow: hidden;
        }

        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 100;
        }

        .world {
            position: absolute;
            width: 2000px;
            height: 100vh;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        /* HUD OTTIMIZZATO - SOLO DESKTOP */
        .futuristic-hud {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(180deg, 
                rgba(10, 10, 15, 0.95) 0%, 
                rgba(26, 26, 46, 0.85) 70%, 
                rgba(26, 26, 46, 0.3) 90%,
                transparent 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            pointer-events: none;
            z-index: 150;
            overflow: hidden;
        }

        .futuristic-hud::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 255, 255, 0.03) 25%, 
                rgba(139, 92, 246, 0.05) 50%, 
                rgba(0, 255, 136, 0.03) 75%, 
                transparent 100%);
            animation: hologramScan 4s linear infinite;
        }

        @keyframes hologramScan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(200%); }
        }

        .hud-layout {
            display: grid;
            grid-template-columns: 220px 1fr auto auto auto 220px;
            gap: 12px;
            padding: 12px 20px;
            height: 100%;
            align-items: center;
        }

        /* Player panel compatto */
        .player-panel {
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.15) 0%, 
                rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 10px 14px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
        }

        .player-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--neon-blue) 30%, 
                var(--neon-purple) 70%, 
                transparent 100%);
            animation: energyFlow 3s ease-in-out infinite;
        }

        @keyframes energyFlow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 38px;
            height: 38px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .player-avatar::before {
            content: 'üöÄ';
            z-index: 2;
            position: relative;
        }

        .player-details {
            flex: 1;
        }

        .player-name {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--neon-blue);
            text-shadow: 0 0 6px var(--neon-blue);
            margin-bottom: 2px;
        }

        .player-level {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-badge {
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-pink));
            color: white;
            padding: 1px 6px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 6px;
        }

        /* Dashboard centrale ottimizzato */
        .game-dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            justify-content: center;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 12px;
            text-align: center;
            min-width: 80px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.5;
        }

        .metric-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        .metric-value {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 0 0 4px currentColor;
        }

        .score-card { color: var(--neon-green); }
        .time-card { color: var(--neon-cyan); }
        .crystals-card { color: var(--neon-purple); }

        /* Energy System compatto */
        .energy-system {
            background: linear-gradient(135deg, 
                rgba(255, 107, 53, 0.15) 0%, 
                rgba(255, 59, 59, 0.1) 100%);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 12px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(15px);
            position: relative;
        }

        .energy-system::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--neon-orange) 30%, 
                var(--neon-red) 70%, 
                transparent 100%);
            animation: energyFlow 2s ease-in-out infinite reverse;
        }

        .energy-icon {
            width: 30px;
            height: 30px;
            background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }

        .energy-icon::before {
            content: '‚ö°';
        }

        .energy-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .energy-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .energy-bar {
            display: flex;
            gap: 3px;
        }

        .energy-orb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));
            box-shadow: 0 0 8px var(--neon-orange);
            position: relative;
            overflow: hidden;
        }

        .energy-orb::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: orbPulse 1.5s ease-in-out infinite;
        }

        .energy-orb.empty {
            background: linear-gradient(45deg, 
                rgba(255, 107, 53, 0.2), 
                rgba(255, 59, 59, 0.2));
            box-shadow: 0 0 4px rgba(255, 107, 53, 0.2);
        }

        .energy-orb.empty::before {
            display: none;
        }

        @keyframes orbPulse {
            0%, 100% { opacity: 0.4; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Control Buttons ottimizzati */
        .control-cluster {
            display: flex;
            gap: 8px;
            pointer-events: all;
        }

        .neo-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid;
            color: white;
            padding: 10px 12px;
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
            min-width: 42px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .neo-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.4s ease;
        }

        .neo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .neo-btn:hover::before {
            left: 100%;
        }

        .neo-btn:active {
            transform: translateY(0);
            transition: transform 0.1s ease;
        }

        .home-btn {
            color: var(--neon-orange);
            border-color: var(--neon-orange);
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.2);
        }

        .home-btn:hover {
            background: var(--neon-orange);
            color: var(--dark-bg);
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.4);
        }

        .pause-btn {
            color: var(--neon-red);
            border-color: var(--neon-red);
            box-shadow: 0 0 10px rgba(255, 59, 59, 0.2);
        }

        .pause-btn:hover {
            background: var(--neon-red);
            color: white;
            box-shadow: 0 4px 20px rgba(255, 59, 59, 0.4);
        }

        .restart-btn {
            color: var(--neon-green);
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .restart-btn:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.4);
        }

        .control-group {
            display: flex;
            gap: 15px;
        }

        .control-btn {
            background: var(--glass);
            border: 3px solid var(--neon-blue);
            border-radius: 50%;
            width: 85px; /* Dimensione base - verr√† sovrascritta dai breakpoint */
            height: 85px;
            color: var(--neon-blue);
            font-size: 1.9rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .control-btn:active {
            background: var(--neon-blue) !important;
            color: white !important;
            transform: scale(0.9);
            box-shadow: var(--glow) var(--neon-blue);
        }

        /* Responsive per mobile controls */
        .control-group {
            display: flex;
            gap: 25px; /* Gap base - verr√† sovrascritta dai breakpoint se necessario */
        }

        /* Mobile controls - distanziamento migliorato */
        .mobile-controls {
            position: absolute;
            bottom: 25px; /* Base - verr√† sovrascritta dai breakpoint */
            left: 25px;
            right: 25px;
            display: none;
            justify-content: space-between;
            align-items: center;
            pointer-events: all;
            z-index: 200;
        }

        /* Mostrati quando √® attiva la classe .touch-device */
        body.touch-device .mobile-controls {
            display: flex !important;
        }

        .audio-btn, .quality-btn {
            background: var(--glass);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 1rem;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }

        .audio-btn:hover, .quality-btn:hover {
            background: var(--neon-blue);
            color: white;
        }

        .audio-btn.muted {
            color: var(--neon-red);
            border-color: var(--neon-red);
        }

        .quality-btn.low-quality {
            color: var(--neon-orange);
            border-color: var(--neon-orange);
        }

        /* Game Objects */
        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-green));
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            z-index: 10;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
            transition: none;
        }

        .player.moving {
            animation: playerPulse 0.5s ease-in-out infinite alternate;
        }

        .player.invulnerable {
            animation: playerFlash 0.2s ease-in-out infinite;
        }

        .player.respawning {
            pointer-events: none;
            animation: respawnFlash 0.15s ease-in-out infinite;
        }

        /* NUOVA ANIMAZIONE DEATH */
        .player.dying {
            animation: playerDeath 0.8s ease-out forwards;
            z-index: 50;
        }

        @keyframes playerDeath {
            0% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
                box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
            }
            25% { 
                transform: scale(1.2) rotate(90deg);
                opacity: 0.8;
                box-shadow: 0 0 30px rgba(255, 59, 59, 0.8);
            }
            50% { 
                transform: scale(0.8) rotate(180deg);
                opacity: 0.6;
                box-shadow: 0 0 40px rgba(255, 59, 59, 1);
            }
            75% { 
                transform: scale(0.4) rotate(270deg);
                opacity: 0.3;
                box-shadow: 0 0 20px rgba(255, 59, 59, 0.5);
            }
            100% { 
                transform: scale(0) rotate(360deg);
                opacity: 0;
                box-shadow: 0 0 5px rgba(255, 59, 59, 0.2);
            }
        }

        @keyframes playerPulse {
            from { box-shadow: 0 0 15px rgba(0, 212, 255, 0.5); }
            to { box-shadow: 0 0 25px rgba(0, 212, 255, 0.8); }
        }

        @keyframes playerFlash {
            0%, 60% { opacity: 1; }
            61%, 100% { opacity: 0.2; }
        }

        @keyframes respawnFlash {
            0%, 70% { opacity: 1; }
            71%, 100% { opacity: 0.05; }
        }

        .platform {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-purple), var(--dark-surface));
            border-radius: 6px;
            box-shadow: var(--glow) rgba(139, 92, 246, 0.3);
            will-change: transform;
            contain: layout style paint;
        }

        .collectible {
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, var(--neon-green) 0%, var(--neon-blue) 70%);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--neon-green);
            animation: collectibleFloat 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .collectible::before {
            content: 'üíé';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        @keyframes collectibleFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(180deg); }
        }

        .enemy {
            position: absolute;
            background: linear-gradient(45deg, var(--neon-orange), #ff4444);
            border-radius: 50%;
            box-shadow: var(--glow) var(--neon-orange);
            animation: enemyPulse 1.5s ease-in-out infinite;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            contain: layout style paint;
        }

        .enemy::before {
            content: 'üëæ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
        }

        @keyframes enemyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .goal {
            position: absolute;
            width: 50px;
            height: 80px;
            background: linear-gradient(0deg, var(--neon-green), var(--neon-blue));
            border-radius: 12px;
            box-shadow: var(--glow) var(--neon-green);
            animation: goalBeacon 2s ease-in-out infinite;
            will-change: transform;
            contain: layout style paint;
        }

        .goal::before {
            content: 'üåÄ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
            animation: goalSpin 3s linear infinite;
        }

        @keyframes goalBeacon {
            0%, 100% { 
                box-shadow: var(--glow) var(--neon-green);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 40px var(--neon-green), 0 0 60px var(--neon-blue);
                transform: scale(1.05);
            }
        }

        @keyframes goalSpin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Overlay System */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .overlay.active {
            display: flex;
            opacity: 1;
        }

        .overlay-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 450px;
            width: 90%;
            box-shadow: var(--shadow-deep), var(--glow) rgba(0, 212, 255, 0.2);
        }

        .overlay-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: var(--glow) currentColor;
        }

        .success { color: var(--neon-green); }
        .danger { color: var(--neon-orange); }

        /* Pause Overlay */
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(15px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .pause-overlay.active {
            display: flex;
            opacity: 1;
        }

        .pause-content {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: var(--shadow-deep), var(--glow) rgba(255, 59, 59, 0.2);
        }

        .pause-title {
            font-family: 'Orbitron', 'Orbitron-Fallback', 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--neon-red);
            text-shadow: var(--glow) var(--neon-red);
        }

        /* Story buttons */
        .story-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Animazioni */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(0); opacity: 1; }
            to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
        }
        
        @keyframes messageSlide {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        @keyframes collectEffect {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* DEBUG INFO - Rimosso in produzione */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: lime;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 5px;
            z-index: 9999;
            display: none;
        }

        body.debug .debug-info {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">RETROAVIA</div>
        <div class="loading-progress">
            <div id="loadingBar" class="loading-bar"></div>
        </div>
        <div id="loadingText" class="loading-text">Inizializzazione dimensioni...</div>
    </div>

    <!-- Debug info -->
    <div class="debug-info" id="debugInfo">
        Touch: <span id="debugTouch">-</span><br>
        Screen: <span id="debugScreen">-</span><br>
        Controls: <span id="debugControls">-</span><br>
        Audio Pos: <span id="debugAudioPos">-</span>
    </div>

    <!-- Animated Background -->
    <div class="animated-background">
        <div class="background-layer stars" id="starsLayer"></div>
        <div class="energy-wave"></div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="tutorial-overlay">
        <div class="tutorial-content">
            <div class="tutorial-title">üéÆ GUIDA AI COMANDI</div>
            <div class="tutorial-controls">
                <div class="tutorial-control">
                    <span class="tutorial-key">‚Üê</span><span class="tutorial-key">‚Üí</span>
                    <div>Movimento laterale</div>
                </div>
                <div class="tutorial-control">
                    <span class="tutorial-key">SPAZIO</span>
                    <div>Salto quantico</div>
                </div>
                <div class="tutorial-control">
                    <span class="tutorial-key">P</span>
                    <div>Pausa tattica</div>
                </div>
                <div class="tutorial-control">
                    <span class="tutorial-key">R</span>
                    <div>Reset dimensionale</div>
                </div>
            </div>
            <p style="margin: 20px 0; color: rgba(255, 255, 255, 0.8);">
                Su dispositivi touch: usa i controlli virtuali in basso
            </p>
            <button class="btn" onclick="closeTutorial()">‚úÖ HO CAPITO</button>
        </div>
    </div>

    <!-- Story Overlay -->
    <div id="storyOverlay" class="story-overlay">
        <div class="story-content">
            <div id="storyTitle" class="story-title">LIVELLO 1</div>
            <div id="storyText" class="story-text">Loading story...</div>
            <div class="story-buttons">
                <button id="storyActionBtn" class="btn" onclick="handleStoryAction()">CONTINUA</button>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pauseOverlay" class="pause-overlay">
        <div class="pause-content">
            <div class="pause-title">‚è∏Ô∏è PAUSA</div>
            <p style="margin-bottom: 20px; font-size: 1rem; color: rgba(255, 255, 255, 0.8);">
                Il gioco √® in pausa. Prenditi una pausa, esploratore!
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn" onclick="resumeGame()">‚ñ∂Ô∏è RIPRENDI</button>
                <button class="btn" onclick="restartGame()">üîÑ RIAVVIA GIOCO</button>
                <button class="btn" style="background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));" onclick="goHomeFromPause()">üè† MENU PRINCIPALE</button>
            </div>
        </div>
    </div>

    <!-- MENU PRINCIPALE -->
    <div id="mainMenu" class="screen active">
        <div class="main-menu-container">
            <!-- Logo e titolo -->
            <div class="retro-logo">
                <div class="retro-text">RETROAVIA</div>
                <div class="dark-chronicles">The Dark Chronicles</div>
            </div>
            
            <!-- Mission briefing compatto -->
            <div class="mission-briefing">
                <div class="briefing-intro">
                    üåå <strong>L'Osservatorio Quantico</strong> ha rilevato una <em>catastrofica destabilizzazione</em> nelle dimensioni digitali. 
                    Le entit√† corrotte stanno divorando la realt√† stessa. Tu sei l'ultimo <strong>Esploratore Dimensionale</strong> rimasto.
                </div>
                
                <div class="mission-cards">
                    <div class="mission-card objective-card">
                        <span class="card-icon">üéØ</span>
                        <div class="card-title">MISSIONE CRITICA</div>
                        <div class="card-description">
                            Raccogli tutti i cristalli energetici e raggiungi i portali dimensionali. 
                            Ogni cristallo stabilizza un frammento di realt√†.
                        </div>
                    </div>
                    
                    <div class="mission-card controls-card">
                        <span class="card-icon">üéÆ</span>
                        <div class="card-title">COMANDI TATTICI</div>
                        <div class="card-description">
                            <strong>‚Üê ‚Üí</strong> Movimento<br>
                            <strong>SPAZIO</strong> Salto quantico<br>
                            <strong>P</strong> Pausa tattica<br>
                            <strong>R</strong> Reset dimensionale
                        </div>
                    </div>
                    
                    <div class="mission-card rewards-card">
                        <span class="card-icon">üèÜ</span>
                        <div class="card-title">RICOMPENSE LEGGENDARIE</div>
                        <div class="card-description">
                            <strong>Dimensione Gamma:</strong> Sconto 3%<br>
                            <strong>Dimensione Omega:</strong> Sconto 5%<br>
                            <strong>Completamento:</strong> Gloria eterna!
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Input section -->
            <div class="player-input-section">
                <div class="input-label">üöÄ Identificativo Esploratore</div>
                <input type="text" id="playerName" class="futuristic-input" placeholder="Inserisci il tuo nome da eroe..." maxlength="12">
                <div>
                    <button class="launch-button" onclick="startGame()">
                        üåå INIZIA ESPLORAZIONE
                    </button>
                </div>
                
                <!-- Tutorial Button -->
                <div style="margin-top: 15px;">
                    <button onclick="showTutorial()" style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid var(--neon-cyan);
                        color: var(--neon-cyan);
                        padding: 8px 20px;
                        border-radius: 8px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.8rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='var(--neon-cyan)'; this.style.color='white'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.color='var(--neon-cyan)'">
                        üìñ Guida Comandi
                    </button>
                </div>
                
                <!-- Link Instagram -->
                <div style="margin-top: 30px; text-align: center;">
                    <a href="https://www.instagram.com/retroavia_" target="_blank" rel="noopener noreferrer" style="
                        display: inline-flex;
                        align-items: center;
                        gap: 10px;
                        background: linear-gradient(45deg, #E4405F, #C13584, #833AB4);
                        color: white;
                        padding: 12px 20px;
                        text-decoration: none;
                        border-radius: 25px;
                        font-family: 'Orbitron', monospace;
                        font-size: 0.9rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(196, 53, 132, 0.3);
                        animation: fadeInUp 1s ease-out 1.9s both;
                    " onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 25px rgba(196, 53, 132, 0.5)'" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(196, 53, 132, 0.3)'">
                        <span style="font-size: 1.2rem;">üì∑</span>
                        <span>Seguici su Instagram</span>
                        <span style="font-weight: 400; opacity: 0.9;">@retroavia_</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div class="game-container">
            <div class="game-ui">
                <!-- HUD DESKTOP OTTIMIZZATO -->
                <div class="futuristic-hud">
                    <div class="hud-layout">
                        <!-- Player Info Panel -->
                        <div class="player-panel">
                            <div class="player-info">
                                <div class="player-avatar"></div>
                                <div class="player-details">
                                    <div class="player-name" id="hud-name">Explorer</div>
                                    <div class="player-level">
                                        Dimension <span class="level-badge" id="hud-level">1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Metrics -->
                        <div class="game-dashboard">
                            <div class="metric-card score-card">
                                <div class="metric-label">Score</div>
                                <div class="metric-value" id="hud-score">0</div>
                            </div>
                            <div class="metric-card time-card">
                                <div class="metric-label">Time</div>
                                <div class="metric-value" id="hud-time">0:00</div>
                            </div>
                            <div class="metric-card crystals-card">
                                <div class="metric-label">Crystals</div>
                                <div class="metric-value" id="hud-crystals">0/0</div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="control-cluster">
                            <button class="neo-btn home-btn" onclick="goHome()" title="Torna al menu">üè†</button>
                            <button class="neo-btn pause-btn" onclick="pauseGame()" title="Pausa (P)">‚è∏Ô∏è</button>
                            <button class="neo-btn restart-btn" onclick="restartGame()" title="Riavvia Gioco (R)">üîÑ</button>
                        </div>
                        
                        <!-- Energy System -->
                        <div class="energy-system">
                            <div class="energy-icon"></div>
                            <div class="energy-display">
                                <div class="energy-label">Energy</div>
                                <div class="energy-bar" id="energy-bar">
                                    <div class="energy-orb"></div>
                                    <div class="energy-orb"></div>
                                    <div class="energy-orb"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DASHBOARD MOBILE ORIZZONTALE - IN ALTO -->
                <div class="mobile-dashboard" id="mobileDashboard">
                    <!-- Player info compatta a sinistra -->
                    <div class="mobile-player-info">
                        <div class="mobile-avatar"></div>
                        <div class="mobile-player-details">
                            <div class="mobile-player-name" id="mobile-player-name">Explorer</div>
                            <div class="mobile-player-level">Lv <span id="mobile-player-level">1</span></div>
                        </div>
                    </div>
                    
                    <!-- Metriche centrali in fila -->
                    <div class="mobile-metric score">
                        <div class="mobile-metric-label">Score</div>
                        <div class="mobile-metric-value" id="mobile-score">0</div>
                    </div>
                    
                    <div class="mobile-metric time">
                        <div class="mobile-metric-label">Time</div>
                        <div class="mobile-metric-value" id="mobile-time">0:00</div>
                    </div>
                    
                    <div class="mobile-metric crystals">
                        <div class="mobile-metric-label">Crystals</div>
                        <div class="mobile-metric-value" id="mobile-crystals">0/0</div>
                    </div>
                    
                    <div class="mobile-metric energy">
                        <div class="mobile-metric-label">Energy</div>
                        <div class="mobile-metric-value" id="mobile-energy">3/3</div>
                    </div>
                </div>

                <!-- Audio e Quality controls - POSIZIONAMENTO INTELLIGENTE -->
                <div class="audio-controls" id="audioControls">
                    <button id="audioToggle" class="audio-btn" onclick="toggleAudio()" title="Audio Toggle">üîä</button>
                    <button id="qualityToggle" class="quality-btn" onclick="toggleQuality()" title="Qualit√† Grafica">‚öôÔ∏è</button>
                </div>
            </div>
            
            <div id="world" class="world"></div>
            
            <!-- Mobile Controls - SISTEMA OTTIMIZZATO -->
            <div class="mobile-controls" id="mobileControls">
                <div class="control-group">
                    <div class="control-btn" id="leftBtn">‚Üê</div>
                    <div class="control-btn" id="rightBtn">‚Üí</div>
                </div>
                <div class="control-group">
                    <div class="control-btn" id="jumpBtn">‚Üë</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Overlay -->
    <div id="gameOverlay" class="overlay">
        <div class="overlay-content">
            <div id="overlayTitle" class="overlay-title">Livello Completato!</div>
            <div id="overlayContent"></div>
            <button id="overlayButton" class="btn" onclick="nextAction()">CONTINUA</button>
        </div>
    </div>

    <script>
        // ====== SISTEMA DI LOADING E INIZIALIZZAZIONE ======
        class LoadingManager {
            constructor() {
                this.loadingSteps = [
                    { text: "Inizializzazione dimensioni...", delay: 300 },
                    { text: "Caricamento entit√† corrotte...", delay: 400 },
                    { text: "Sincronizzazione cristalli energetici...", delay: 500 },
                    { text: "Attivazione motore quantico...", delay: 600 },
                    { text: "Calibrazione controlli...", delay: 400 },
                    { text: "Finalizzazione interfaccia...", delay: 300 },
                    { text: "Pronto per l'esplorazione!", delay: 200 }
                ];
                this.currentStep = 0;
            }

            async start() {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingBar = document.getElementById('loadingBar');
                const loadingText = document.getElementById('loadingText');
                
                for (let i = 0; i < this.loadingSteps.length; i++) {
                    const step = this.loadingSteps[i];
                    loadingText.textContent = step.text;
                    
                    const progress = ((i + 1) / this.loadingSteps.length) * 100;
                    loadingBar.style.width = progress + '%';
                    
                    await new Promise(resolve => setTimeout(resolve, step.delay));
                }
                
                // Nascondi loading screen
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 800);
                }, 300);
            }
        }

        // ====== SISTEMA DI SALVATAGGIO PROGRESSO ======
        class ProgressManager {
            constructor() {
                this.storageKey = 'retroavia_progress';
            }

            saveProgress(data) {
                try {
                    const progressData = {
                        playerName: data.playerName || '',
                        highestLevel: data.highestLevel || 1,
                        bestScore: data.bestScore || 0,
                        totalPlaytime: data.totalPlaytime || 0,
                        completedLevels: data.completedLevels || [],
                        unlockedRewards: data.unlockedRewards || [],
                        lastPlayed: Date.now(),
                        version: '1.0'
                    };
                    localStorage.setItem(this.storageKey, JSON.stringify(progressData));
                    return true;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Impossibile salvare progresso:', error);
                    return false;
                }
            }

            loadProgress() {
                try {
                    const saved = localStorage.getItem(this.storageKey);
                    if (saved) {
                        const data = JSON.parse(saved);
                        // Verifica versione compatibilit√†
                        if (data.version === '1.0') {
                            return data;
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Errore caricamento progresso:', error);
                }
                return this.getDefaultProgress();
            }

            getDefaultProgress() {
                return {
                    playerName: '',
                    highestLevel: 1,
                    bestScore: 0,
                    totalPlaytime: 0,
                    completedLevels: [],
                    unlockedRewards: [],
                    lastPlayed: 0,
                    version: '1.0'
                };
            }

            updateLevelProgress(level, score, completed = false) {
                const progress = this.loadProgress();
                if (completed && !progress.completedLevels.includes(level)) {
                    progress.completedLevels.push(level);
                }
                if (level > progress.highestLevel) {
                    progress.highestLevel = level;
                }
                if (score > progress.bestScore) {
                    progress.bestScore = score;
                }
                this.saveProgress(progress);
            }
        }

        // ====== FUNZIONI GLOBALI DEFINITE PER PRIME ======
        let gameManager = null;
        let deviceInfo = {
            isTouch: false,
            isMobile: false,
            isTablet: false,
            screenWidth: 0,
            screenHeight: 0
        };

        // FUNZIONI GLOBALI IMMEDIATE
        function startGame() {
            console.log('üéÆ startGame() chiamata');
            try {
                if (gameManager && gameManager.startGame) {
                    gameManager.startGame();
                } else {
                    console.warn('‚ö†Ô∏è Game Manager non pronto, provo inizializzazione...');
                    setTimeout(() => {
                        if (gameManager && gameManager.startGame) {
                            gameManager.startGame();
                        } else {
                            showNotification('Errore: Game Manager non inizializzato. Ricarica la pagina.');
                        }
                    }, 100);
                }
            } catch (error) {
                console.error('‚ùå Errore in startGame:', error);
                showNotification('Si √® verificato un errore. Ricarica la pagina.');
            }
        }

        function handleStoryAction() {
            if (gameManager && gameManager.handleStoryAction) {
                gameManager.handleStoryAction();
            }
        }

        function pauseGame() {
            if (gameManager && gameManager.pauseGame) {
                gameManager.pauseGame();
            }
        }

        function resumeGame() {
            if (gameManager && gameManager.resumeGame) {
                gameManager.resumeGame();
            }
        }

        function restartGame() {
            if (gameManager && gameManager.restartLevel) {
                gameManager.restartLevel();
            }
        }

        function goHomeFromPause() {
            if (gameManager && gameManager.goHomeFromPause) {
                gameManager.goHomeFromPause();
            }
        }

        function goHome() {
            if (gameManager && gameManager.goHome) {
                gameManager.goHome();
            }
        }

        function toggleAudio() {
            if (gameManager && gameManager.toggleAudio) {
                gameManager.toggleAudio();
            }
        }

        function toggleQuality() {
            if (gameManager && gameManager.toggleQuality) {
                gameManager.toggleQuality();
            }
        }

        function nextAction() {
            if (gameManager && gameManager.nextAction) {
                gameManager.nextAction();
            }
        }

        function showTutorial() {
            const tutorialOverlay = document.getElementById('tutorialOverlay');
            if (tutorialOverlay) {
                tutorialOverlay.classList.add('active');
                if (gameManager && gameManager.game && gameManager.game.audioManager) {
                    gameManager.game.audioManager.playSound('button');
                }
            }
        }

        function closeTutorial() {
            const tutorialOverlay = document.getElementById('tutorialOverlay');
            if (tutorialOverlay) {
                tutorialOverlay.classList.remove('active');
                if (gameManager && gameManager.game && gameManager.game.audioManager) {
                    gameManager.game.audioManager.playSound('button');
                }
            }
        }

        function copyRewardCode(code) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showSuccessNotification('‚úÖ Codice copiato negli appunti!');
                }).catch(() => {
                    fallbackCopyText(code);
                });
            } else {
                fallbackCopyText(code);
            }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showSuccessNotification('‚úÖ Codice copiato negli appunti!');
            } catch (err) {
                showNotification('‚ùå Errore nella copia. Seleziona e copia manualmente.');
            }
            
            document.body.removeChild(textArea);
        }

        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'successPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 600);
            }, 2500);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(45deg, var(--neon-orange), var(--neon-red));
                color: white;
                padding: 15px 25px;
                border-radius: 12px;
                font-family: 'Orbitron', monospace;
                font-weight: 700;
                z-index: 5000;
                animation: slideDown 0.3s ease;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                max-width: 90%;
                text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // ====== SISTEMA DI RILEVAMENTO DISPOSITIVO MIGLIORATO ======
        function detectDevice() {
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const width = window.innerWidth;
            const height = window.innerHeight;
            
            deviceInfo = {
                isTouch: hasTouch,
                isExtraSmallMobile: width <= 375,
                isSmallMobile: width > 375 && width <= 480,
                isLargeMobile: width > 480 && width <= 767,
                isTabletPortrait: width >= 768 && width <= 1024 && height > width,
                isTabletLandscape: width >= 768 && width <= 1024 && width > height,
                isDesktop: width > 1024,
                isMobile: width <= 767,
                isTablet: width >= 768 && width <= 1024,
                screenWidth: width,
                screenHeight: height,
                orientation: width > height ? 'landscape' : 'portrait',
                // Device specific detection
                isIPhone13Mini: width <= 375 && height <= 812,
                isIPhone14Standard: width >= 376 && width <= 415 && height >= 800,
                isIPhone14Plus: width >= 416 && width <= 480
            };

            // Add touch class
            if (deviceInfo.isTouch) {
                document.body.classList.add('touch-device');
            } else {
                document.body.classList.remove('touch-device');
            }

            // Debug info update
            if (document.getElementById('debugInfo')) {
                updateDebugInfo();
            }

            updateMobileControls();
        }

        function updateDebugInfo() {
            const debugTouch = document.getElementById('debugTouch');
            const debugScreen = document.getElementById('debugScreen');
            
            if (debugTouch) {
                debugTouch.textContent = deviceInfo.isTouch ? 'YES' : 'NO';
            }
            
            if (debugScreen) {
                debugScreen.textContent = `${deviceInfo.screenWidth}x${deviceInfo.screenHeight}`;
            }
        }

        function updateMobileControls() {
            const mobileControls = document.getElementById('mobileControls');
            const mobileDashboard = document.getElementById('mobileDashboard');
            
            if (deviceInfo.isTouch) {
                if (mobileControls) {
                    mobileControls.style.display = 'flex';
                }
                if (mobileDashboard) {
                    mobileDashboard.style.display = 'flex';
                }
            } else {
                if (mobileControls) {
                    mobileControls.style.display = 'none';
                }
                if (mobileDashboard) {
                    mobileDashboard.style.display = 'none';
                }
            }
        }

        // ====== CLASSI DEL GIOCO ======
        
        // AUDIO MANAGER MIGLIORATO
        class AudioManager {
            constructor() {
                this.audioContext = null;
                this.masterGain = null;
                this.musicGain = null;
                this.sfxGain = null;
                this.isEnabled = true;
                this.isInitialized = false;
                this.sounds = {};
                this.musicVolume = 0.2;
                this.sfxVolume = 0.5;
                this.musicOscillators = [];
                this.currentMusicLevel = 0;
                this.userInteracted = false;
                this.initializationPromise = null;
            }

            async init() {
                if (this.initializationPromise) {
                    return this.initializationPromise;
                }

                this.initializationPromise = this.performInit();
                return this.initializationPromise;
            }

            async performInit() {
                if (this.isInitialized) return true;
                
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    if (!AudioContextClass) {
                        console.warn('üéµ Web Audio API non supportata');
                        return false;
                    }
                    
                    this.audioContext = new AudioContextClass();
                    
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    this.masterGain = this.audioContext.createGain();
                    this.musicGain = this.audioContext.createGain();
                    this.sfxGain = this.audioContext.createGain();
                    
                    this.masterGain.connect(this.audioContext.destination);
                    this.musicGain.connect(this.masterGain);
                    this.sfxGain.connect(this.masterGain);
                    
                    this.masterGain.gain.value = this.isEnabled ? 1 : 0;
                    this.musicGain.gain.value = this.musicVolume;
                    this.sfxGain.gain.value = this.sfxVolume;
                    
                    this.createSounds();
                    
                    this.isInitialized = true;
                    this.userInteracted = true;
                    
                    console.log('üéµ Audio Manager inizializzato con successo');
                    return true;
                } catch (error) {
                    console.error('‚ùå Errore inizializzazione audio:', error);
                    this.isEnabled = false;
                    this.isInitialized = false;
                    return false;
                }
            }

            createSounds() {
                this.sounds = {
                    button: () => this.playTone(800, 0.1, 'square'),
                    jump: () => this.playTone(440, 0.15, 'sine'),
                    collect: () => this.playMelody([523, 659, 784], 0.1),
                    hit: () => this.playTone(150, 0.3, 'sawtooth'),
                    complete: () => this.playMelody([523, 659, 784, 1047], 0.15),
                    levelStart: () => this.playMelody([392, 523, 659], 0.2),
                    powerup: () => this.playMelody([440, 554, 659, 880], 0.12),
                    death: () => this.playTone(220, 0.5, 'sawtooth')
                };
            }

            playTone(frequency, duration, type = 'sine') {
                if (!this.audioContext || !this.isEnabled || !this.isInitialized) return;
                
                try {
                    const osc = this.audioContext.createOscillator();
                    const gain = this.audioContext.createGain();
                    
                    osc.connect(gain);
                    gain.connect(this.sfxGain);
                    
                    osc.frequency.value = frequency;
                    osc.type = type;
                    
                    gain.gain.setValueAtTime(0, this.audioContext.currentTime);
                    gain.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                    
                    osc.start();
                    osc.stop(this.audioContext.currentTime + duration);
                } catch (error) {
                    console.warn('üéµ Errore riproduzione tono:', error);
                }
            }

            playMelody(frequencies, noteDuration) {
                frequencies.forEach((freq, i) => {
                    setTimeout(() => {
                        this.playTone(freq, noteDuration, 'triangle');
                    }, i * noteDuration * 400);
                });
            }

            async playSound(soundName) {
                if (!this.userInteracted || !this.isInitialized) {
                    const success = await this.init();
                    if (!success) return;
                }
                
                if (!this.audioContext || this.audioContext.state !== 'running') {
                    return;
                }
                
                if (this.sounds[soundName] && this.isEnabled) {
                    try {
                        this.sounds[soundName]();
                    } catch (error) {
                        console.warn('üéµ Errore riproduzione suono', soundName, ':', error);
                    }
                }
            }

            async toggle() {
                if (!this.isInitialized) {
                    await this.init();
                }
                
                this.isEnabled = !this.isEnabled;
                
                if (this.masterGain) {
                    this.masterGain.gain.value = this.isEnabled ? 1 : 0;
                }
                
                this.updateAudioButton();
            }

            updateAudioButton() {
                const btn = document.getElementById('audioToggle');
                if (btn) {
                    btn.textContent = this.isEnabled ? 'üîä' : 'üîá';
                    btn.className = this.isEnabled ? 'audio-btn' : 'audio-btn muted';
                }
            }

            startLevelMusic(level) {
                // Implementazione musica di sottofondo semplificata
                console.log('üéµ Musica livello', level);
            }

            stopMusic() {
                this.musicOscillators.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
                this.musicOscillators = [];
            }
        }

        // RENDER ENGINE MIGLIORATO
        class RenderEngine {
            constructor() {
                this.performanceMode = 'high';
                this.frameCounter = 0;
                this.lastFPSCheck = 0;
                this.currentFPS = 60;
                this.autoQualityEnabled = true;
            }

            setQualityMode(mode) {
                this.performanceMode = mode;
                const body = document.body;
                
                if (mode === 'low') {
                    body.classList.add('low-quality');
                } else {
                    body.classList.remove('low-quality');
                }

                this.updateQualityButton();
            }

            updateQualityButton() {
                const btn = document.getElementById('qualityToggle');
                if (btn) {
                    btn.className = this.performanceMode === 'low' ? 'quality-btn low-quality' : 'quality-btn';
                }
            }

            checkPerformance() {
                this.frameCounter++;
                const now = performance.now();
                
                if (now - this.lastFPSCheck >= 1000) {
                    this.currentFPS = this.frameCounter;
                    this.frameCounter = 0;
                    this.lastFPSCheck = now;
                    
                    // Auto quality adjustment
                    if (this.autoQualityEnabled) {
                        if (this.currentFPS < 45 && this.performanceMode === 'high') {
                            console.log('üéÆ FPS basso, switching to low quality');
                            this.setQualityMode('low');
                        } else if (this.currentFPS > 55 && this.performanceMode === 'low') {
                            console.log('üéÆ FPS migliorato, switching to high quality');
                            this.setQualityMode('high');
                        }
                    }
                }
            }
        }

        // STORY MANAGER MIGLIORATO
        class StoryManager {
            constructor() {
                this.stories = {
                    intro1: {
                        title: "üåå DIMENSIONE ALPHA - IL RISVEGLIO",
                        text: `L'Osservatorio Quantico ha rilevato una catastrofica destabilizzazione nelle dimensioni digitali. Le entit√† corrotte stanno divorando la realt√† stessa.

Tu sei l'ultimo Esploratore Dimensionale rimasto. I cristalli energetici sono la chiave per stabilizzare ogni dimensione prima che collassi nel vuoto.

La tua prima missione: raccogliere tutti i cristalli nella Dimensione Alpha e raggiungere il portale di stabilizzazione. Il tempo √® contro di te, esploratore.`,
                        level: 1,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro1: {
                        title: "‚ú® ALPHA STABILIZZATA",
                        text: `Eccellente lavoro! La Dimensione Alpha √® stata stabilizzata. I suoi abitanti digitali possono ora respirare di nuovo.

Ma questo √® solo l'inizio. I sensori rilevano anomalie ancora pi√π gravi nelle dimensioni successive. Le entit√† corrotte stanno imparando dai tuoi movimenti.

Preparati per la Dimensione Beta, dove la gravit√† sfida le leggi della fisica...`,
                        level: 1,
                        actionText: "CONTINUA"
                    },
                    intro2: {
                        title: "üåä DIMENSIONE BETA - LE ISOLE FLUTTUANTI",
                        text: `Benvenuto nella Dimensione Beta, un reticolo di isole energetiche sospese nel vuoto quantico. Qui la gravit√† segue regole diverse.

Le piattaforme sono instabili e le entit√† corrotte hanno sviluppato nuove tattiche. Dovrai saltare con precisione millimetrica per sopravvivere.

I cristalli qui contengono energia pura concentrata. Raccoglili tutti prima che le isole si disgreghino nel caos dimensionale.`,
                        level: 2,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro2: {
                        title: "üèÜ BETA PURIFICATA",
                        text: `Le Isole Fluttuanti tornano a brillare! La tua agilit√† ha impressionato anche gli antichi Guardiani Digitali.

Ma attenzione: i rapporti indicano che la prossima dimensione √® controllata da entit√† corrotte evolute. Preparati alla sfida pi√π dura.

Il Guanto di Sfida ti aspetta, dove ogni passo potrebbe essere l'ultimo...`,
                        level: 2,
                        actionText: "CONTINUA"
                    },
                    intro3: {
                        title: "‚öîÔ∏è DIMENSIONE GAMMA - IL GUANTO DI SFIDA",
                        text: `Hai raggiunto la temuta Dimensione Gamma, conosciuta come "Il Guanto". Qui ogni passo √® una trappola, ogni salto una scommessa con la morte.

Le entit√† corrotte hanno organizzato una difesa coordinata. Ti stanno aspettando.

Completa questa prova e guadagnerai il rispetto dell'intera Confederazione Digitale. I cristalli qui non sono solo energia: sono la chiave per ricompense leggendarie.`,
                        level: 3,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro3: {
                        title: "üéñÔ∏è EROE DELLA GAMMA",
                        text: `INCREDIBILE! Hai conquistato il Guanto di Sfida! La Confederazione Digitale ti conferisce il titolo di Eroe Dimensionale.

Come ricompensa per il tuo coraggio, hai sbloccato un codice sconto speciale per il nostro negozio dimensionale.

Ma la guerra non √® finita. Le dimensioni finali ti aspettano con sfide che metteranno alla prova ogni fibra del tuo essere.`,
                        level: 3,
                        actionText: "CONTINUA"
                    },
                    intro4: {
                        title: "üéØ DIMENSIONE DELTA - PRECISIONE ASSOLUTA",
                        text: `Benvenuto nella Dimensione Delta, dove solo i maestri della precisione possono sopravvivere. Ogni piattaforma √® pi√π piccola, ogni salto pi√π pericoloso.

Le entit√† corrotte qui hanno sviluppato tecniche di caccia perfezionate. Si muovono come ombre, colpiscono come fulmini.

Non c'√® spazio per l'errore. Un singolo passo falso significa il ritorno al vuoto quantico. Dimostra di essere degno del titolo di Maestro Esploratore.`,
                        level: 4,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro4: {
                        title: "üèÖ MAESTRO DELLA PRECISIONE",
                        text: `La tua precisione √® leggendaria! La Dimensione Delta si inchina al tuo passaggio. Gli archivi digitali registreranno per sempre la tua impresa.

Rimane un'ultima sfida. La Dimensione Omega, dove risiede l'Entit√† Suprema Corrotta. Il destino di tutte le realt√† digitali √® nelle tue mani.

L'ultima battaglia ti attende nel cuore delle tenebre...`,
                        level: 4,
                        actionText: "CONTINUA"
                    },
                    intro5: {
                        title: "üíÄ DIMENSIONE OMEGA - LO SCONTRO FINALE",
                        text: `Questo √® tutto. La Dimensione Omega, cuore della corruzione, regno dell'Entit√† Suprema. Qui dove tutto √® iniziato, tutto deve finire.

Le piattaforme si dissolvono mentre cammini. Le entit√† corrotte attaccano con furia disperata. E in fondo al livello, TI aspetta.

Fallire qui significa la fine di ogni realt√† digitale. Vincere significa diventare una leggenda immortale. Sei pronto, Esploratore Supremo?`,
                        level: 5,
                        actionText: "INIZIA MISSIONE"
                    },
                    outro5: {
                        title: "üëë SALVATORE DELLE DIMENSIONI",
                        text: `L'HAI FATTO! L'Entit√† Suprema √® stata purificata, le dimensioni sono al sicuro, la realt√† digitale √® salva!

Il tuo nome risuoner√† per l'eternit√† in ogni dimensione. Sei diventato il Salvatore Leggendario, colui che ha riportato l'equilibrio nel multiverso.

Come ricompensa finale, hai sbloccato il codice sconto supremo e la gloria eterna nella storia interdimensionale!`,
                        level: 5,
                        actionText: "CONTINUA"
                    }
                };
            }

            showStory(level, type = 'intro') {
                const key = type + level;
                const story = this.stories[key];
                
                if (!story) return;

                document.getElementById('storyTitle').textContent = story.title;
                document.getElementById('storyText').textContent = story.text;
                
                const actionBtn = document.getElementById('storyActionBtn');
                actionBtn.textContent = story.actionText;
                
                document.getElementById('storyOverlay').classList.add('active');
            }

            hideStory() {
                document.getElementById('storyOverlay').classList.remove('active');
            }
        }

        // GAME CLASS COMPLETAMENTE MIGLIORATA
        class Game {
            constructor() {
                this.state = 'menu';
                this.currentLevel = 1;
                this.maxLevels = 5;
                this.isPaused = false;
                
                this.player = {
                    x: 50, y: 300, vx: 0, vy: 0,
                    width: 40, height: 40,
                    onGround: false, canJump: true,
                    energy: 3, maxEnergy: 3,
                    name: '', coyoteTime: 0,
                    isDying: false, invulnerable: false,
                    invulnerabilityTime: 0
                };
                
                this.camera = { x: 0, targetX: 0 };
                this.score = 0;
                this.startTime = 0;
                this.gameTime = 0;
                this.keys = {};
                this.entities = [];
                this.running = false;
                this.worldWidth = 1800;
                this.gravity = 0.8;
                this.friction = 0.88;
                
                this.lastGoalMessage = 0;
                this.goalMessageCooldown = 2000;
                
                this.lastRenderTime = 0;
                this.targetFPS = 60;
                this.frameInterval = 1000 / this.targetFPS;
                this.visibleEntities = [];
                this.updateCounter = 0;
                this.deltaTime = 0;

                this.story = new StoryManager();
                this.audioManager = new AudioManager();
                this.renderEngine = new RenderEngine();
                this.progressManager = new ProgressManager();
                
                this.setupEventListeners();
                this.setupMobileControls();
                this.initBackground();
                this.loadPlayerProgress();
            }

            loadPlayerProgress() {
                const progress = this.progressManager.loadProgress();
                if (progress.playerName) {
                    const nameInput = document.getElementById('playerName');
                    if (nameInput) {
                        nameInput.value = progress.playerName;
                    }
                }
            }

            initBackground() {
                this.createStars();
            }

            createStars() {
                const starsLayer = document.getElementById('starsLayer');
                if (!starsLayer) return;
                
                starsLayer.innerHTML = '';
                
                const starCount = deviceInfo.isMobile ? 15 : 25;
                for (let i = 0; i < starCount; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        width: ${Math.random() * 2 + 1}px;
                        height: ${Math.random() * 2 + 1}px;
                        opacity: ${Math.random() * 0.4 + 0.2};
                    `;
                    starsLayer.appendChild(star);
                }
            }

            setupEventListeners() {
                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    if (this.isPaused && e.code !== 'KeyP' && e.code !== 'Escape') return;
                    
                    this.keys[e.code] = true;
                    if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Space'].includes(e.code)) {
                        e.preventDefault();
                    }
                    
                    if (e.code === 'KeyP' || e.code === 'Escape') {
                        if (this.state === 'playing') {
                            this.pauseGame();
                        }
                    }
                    
                    if (e.code === 'KeyR' && this.state === 'playing') {
                        this.restartLevel();
                    }
                });

                document.addEventListener('keyup', (e) => {
                    this.keys[e.code] = false;
                });

                // Player name input
                const playerNameInput = document.getElementById('playerName');
                if (playerNameInput) {
                    playerNameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            startGame();
                        }
                    });
                    
                    // Save name on change
                    playerNameInput.addEventListener('input', (e) => {
                        if (e.target.value.length >= 2) {
                            const progress = this.progressManager.loadProgress();
                            progress.playerName = e.target.value;
                            this.progressManager.saveProgress(progress);
                        }
                    });
                }

                // Visibility change (pause when tab loses focus)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.running && this.state === 'playing') {
                        this.pauseGame();
                        this.showMessage('üîÑ Gioco automaticamente in pausa');
                    }
                });

                // Prevent context menu
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                // Prevent double tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', e => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }

            setupMobileControls() {
                const controls = [
                    { id: 'leftBtn', key: 'ArrowLeft' },
                    { id: 'rightBtn', key: 'ArrowRight' },
                    { id: 'jumpBtn', key: 'Space' }
                ];

                controls.forEach(({ id, key }) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        // Touch events
                        btn.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            if (!this.isPaused) {
                                this.keys[key] = true;
                                btn.classList.add('active');
                            }
                        }, { passive: false });
                        
                        btn.addEventListener('touchend', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.keys[key] = false;
                            btn.classList.remove('active');
                        }, { passive: false });
                        
                        btn.addEventListener('touchcancel', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                            btn.classList.remove('active');
                        }, { passive: false });
                        
                        // Mouse events for desktop testing
                        btn.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            if (!this.isPaused) {
                                this.keys[key] = true;
                                btn.classList.add('active');
                            }
                        });
                        
                        btn.addEventListener('mouseup', (e) => {
                            e.preventDefault();
                            this.keys[key] = false;
                            btn.classList.remove('active');
                        });
                        
                        btn.addEventListener('mouseleave', (e) => {
                            this.keys[key] = false;
                            btn.classList.remove('active');
                        });
                        
                        btn.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                        });
                    }
                });
            }

            start(playerName) {
                this.player.name = playerName;
                this.currentLevel = 1;
                this.score = 0;
                this.player.energy = this.player.maxEnergy;
                this.isPaused = false;
                this.startTime = Date.now();
                this.state = 'story';
                
                // Save player name
                const progress = this.progressManager.loadProgress();
                progress.playerName = playerName;
                this.progressManager.saveProgress(progress);
                
                this.story.showStory(1, 'intro');
            }

            startLevel() {
                document.body.classList.add('game-active');
                updateMobileControls();
                
                this.loadLevel();
                this.showScreen('gameScreen');
                this.state = 'playing';
                this.isPaused = false;
                this.running = true;
                
                this.audioManager.startLevelMusic(this.currentLevel);
                this.audioManager.playSound('levelStart');
                
                this.gameLoop();
            }

            pauseGame() {
                if (this.state !== 'playing') return;
                this.isPaused = true;
                this.running = false;
                document.getElementById('pauseOverlay').classList.add('active');
                this.audioManager.playSound('button');
            }

            resumeGame() {
                if (this.state !== 'playing') return;
                this.isPaused = false;
                this.running = true;
                document.getElementById('pauseOverlay').classList.remove('active');
                this.audioManager.playSound('button');
                this.gameLoop();
            }

            restartLevel() {
                this.showRestartConfirmation();
            }

            showRestartConfirmation() {
                if (confirm('Vuoi davvero riavviare il gioco? Tornerai al livello 1.')) {
                    this.performFullRestart();
                }
            }

            performFullRestart() {
                this.isPaused = false;
                this.running = false;
                
                if (document.getElementById('pauseOverlay').classList.contains('active')) {
                    document.getElementById('pauseOverlay').classList.remove('active');
                }
                
                this.currentLevel = 1;
                this.score = 0;
                this.player.energy = this.player.maxEnergy;
                this.startTime = Date.now();
                this.state = 'story';
                
                this.showMessage('üîÑ Gioco riavviato! Iniziando dal Livello 1...');
                
                setTimeout(() => {
                    this.story.showStory(1, 'intro');
                }, 500);
            }

            goHomeFromPause() {
                this.isPaused = false;
                this.running = false;
                document.getElementById('pauseOverlay').classList.remove('active');
                document.body.classList.remove('game-active');
                this.state = 'menu';
                this.audioManager.playSound('button');
                this.showScreen('mainMenu');
            }

            loadLevel() {
                const levels = [
                    // Level 1: Tutorial facile
                    {
                        platforms: [
                            { x: 0, y: 500, w: 200, h: 20 },
                            { x: 300, y: 450, w: 150, h: 20 },
                            { x: 550, y: 400, w: 150, h: 20 },
                            { x: 800, y: 350, w: 200, h: 20 }
                        ],
                        collectibles: [
                            { x: 350, y: 420 },
                            { x: 600, y: 370 },
                            { x: 850, y: 320 }
                        ],
                        enemies: [
                            { x: 400, y: 420, w: 30, h: 30, vx: 1, range: 80, platformBound: true }
                        ],
                        goal: { x: 950, y: 270 }
                    },
                    // Level 2: Pi√π difficile
                    {
                        platforms: [
                            { x: 0, y: 520, w: 150, h: 20 },
                            { x: 200, y: 460, w: 120, h: 20 },
                            { x: 380, y: 400, w: 120, h: 20 },
                            { x: 560, y: 340, w: 120, h: 20 },
                            { x: 740, y: 280, w: 120, h: 20 },
                            { x: 920, y: 220, w: 150, h: 20 }
                        ],
                        collectibles: [
                            { x: 240, y: 430 },
                            { x: 420, y: 370 },
                            { x: 600, y: 310 },
                            { x: 780, y: 250 }
                        ],
                        enemies: [
                            { x: 250, y: 430, w: 25, h: 25, vx: -1, range: 80, platformBound: true },
                            { x: 600, y: 310, w: 25, h: 25, vx: 1, range: 80, platformBound: true }
                        ],
                        goal: { x: 990, y: 140 }
                    },
                    // Level 3: Il Guanto di Sfida
                    {
                        platforms: [
                            { x: 0, y: 500, w: 120, h: 20 },
                            { x: 180, y: 450, w: 100, h: 20 },
                            { x: 340, y: 400, w: 100, h: 20 },
                            { x: 500, y: 350, w: 100, h: 20 },
                            { x: 660, y: 300, w: 100, h: 20 },
                            { x: 820, y: 250, w: 100, h: 20 },
                            { x: 980, y: 200, w: 120, h: 20 }
                        ],
                        collectibles: [
                            { x: 220, y: 420 },
                            { x: 380, y: 370 },
                            { x: 540, y: 320 },
                            { x: 700, y: 270 },
                            { x: 860, y: 220 }
                        ],
                        enemies: [
                            { x: 220, y: 420, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: 1, range: 60, platformBound: true },
                            { x: 540, y: 320, w: 25, h: 25, vx: -1, range: 60, platformBound: true },
                            { x: 700, y: 270, w: 25, h: 25, vx: 1, range: 60, platformBound: true }
                        ],
                        goal: { x: 1040, y: 120 }
                    },
                    // Level 4: Precisione
                    {
                        platforms: [
                            { x: 0, y: 480, w: 100, h: 20 },
                            { x: 150, y: 430, w: 80, h: 20 },
                            { x: 280, y: 380, w: 80, h: 20 },
                            { x: 410, y: 330, w: 80, h: 20 },
                            { x: 540, y: 280, w: 80, h: 20 },
                            { x: 670, y: 230, w: 80, h: 20 },
                            { x: 800, y: 180, w: 80, h: 20 },
                            { x: 930, y: 130, w: 100, h: 20 }
                        ],
                        collectibles: [
                            { x: 180, y: 400 },
                            { x: 310, y: 350 },
                            { x: 440, y: 300 },
                            { x: 570, y: 250 },
                            { x: 700, y: 200 },
                            { x: 830, y: 150 }
                        ],
                        enemies: [
                            { x: 310, y: 350, w: 25, h: 25, vx: 1, range: 50, platformBound: true },
                            { x: 570, y: 250, w: 25, h: 25, vx: -1, range: 50, platformBound: true },
                            { x: 830, y: 150, w: 25, h: 25, vx: 1, range: 50, platformBound: true }
                        ],
                        goal: { x: 980, y: 50 }
                    },
                    // Level 5: Boss finale
                    {
                        platforms: [
                            { x: 0, y: 520, w: 80, h: 20 },
                            { x: 130, y: 480, w: 60, h: 20 },
                            { x: 240, y: 440, w: 60, h: 20 },
                            { x: 350, y: 400, w: 60, h: 20 },
                            { x: 460, y: 360, w: 60, h: 20 },
                            { x: 570, y: 320, w: 60, h: 20 },
                            { x: 680, y: 280, w: 60, h: 20 },
                            { x: 790, y: 240, w: 60, h: 20 },
                            { x: 900, y: 200, w: 60, h: 20 },
                            { x: 1010, y: 160, w: 80, h: 20 }
                        ],
                        collectibles: [
                            { x: 160, y: 450 },
                            { x: 270, y: 410 },
                            { x: 380, y: 370 },
                            { x: 490, y: 330 },
                            { x: 600, y: 290 },
                            { x: 710, y: 250 },
                            { x: 820, y: 210 }
                        ],
                        enemies: [
                            { x: 160, y: 450, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 270, y: 410, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 380, y: 370, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 490, y: 330, w: 25, h: 25, vx: 1, range: 40, platformBound: true },
                            { x: 600, y: 290, w: 25, h: 25, vx: -1, range: 40, platformBound: true },
                            { x: 930, y: 170, w: 35, h: 35, vx: 0, range: 30, platformBound: true } // Boss
                        ],
                        goal: { x: 1040, y: 80 }
                    }
                ];

                const level = levels[this.currentLevel - 1];
                
                this.entities = [];
                this.player.x = 50;
                this.player.y = 400;
                this.player.vx = 0;
                this.player.vy = 0;
                this.player.onGround = false;
                this.player.isDying = false;
                this.player.invulnerable = false;
                this.player.invulnerabilityTime = 0;
                this.camera.x = 0;
                this.camera.targetX = 0;
                
                this.lastGoalMessage = 0;

                // Add platforms
                level.platforms.forEach(p => {
                    this.entities.push({
                        type: 'platform',
                        x: p.x, y: p.y, w: p.w, h: p.h
                    });
                });

                // Add collectibles
                level.collectibles.forEach(c => {
                    this.entities.push({
                        type: 'collectible',
                        x: c.x, y: c.y, w: 25, h: 25,
                        collected: false
                    });
                });

                // Add enemies
                level.enemies.forEach((e, index) => {
                    const enemy = {
                        type: 'enemy',
                        id: `enemy_${index}`,
                        x: e.x, y: e.y, w: e.w, h: e.h,
                        vx: e.vx, vy: 0, health: 1,
                        startX: e.x, range: e.range,
                        onGround: false, platformBound: e.platformBound || false,
                        currentPlatform: null
                    };
                    
                    if (enemy.platformBound) {
                        const platform = level.platforms.find(p => 
                            enemy.x >= p.x && enemy.x + enemy.w <= p.x + p.w &&
                            Math.abs(enemy.y + enemy.h - p.y) < 30
                        );
                        if (platform) {
                            enemy.currentPlatform = platform;
                            enemy.y = platform.y - enemy.h;
                        }
                    }
                    
                    this.entities.push(enemy);
                });

                // Add goal
                this.entities.push({
                    type: 'goal',
                    x: level.goal.x, y: level.goal.y,
                    w: 50, h: 80
                });

                this.updateHUD();
            }

            gameLoop() {
                if (!this.running || this.isPaused) return;

                const currentTime = performance.now();
                this.deltaTime = currentTime - this.lastRenderTime;

                if (this.deltaTime >= this.frameInterval) {
                    this.update(this.deltaTime / 1000);
                    this.render();
                    this.renderEngine.checkPerformance();
                    this.lastRenderTime = currentTime;
                }

                requestAnimationFrame(() => this.gameLoop());
            }

            update(deltaTime) {
                if (this.isPaused || this.player.isDying) return;
                
                this.gameTime = Date.now() - this.startTime;
                this.updateCounter++;

                if (this.updateCounter % 60 === 0) {
                    this.updateTimer();
                }

                this.updatePlayer(deltaTime);
                this.updateEnemies(deltaTime);
                this.updateCamera(deltaTime);
                this.checkCollisions();
                
                // Update invulnerability
                if (this.player.invulnerable) {
                    this.player.invulnerabilityTime -= deltaTime * 1000;
                    if (this.player.invulnerabilityTime <= 0) {
                        this.player.invulnerable = false;
                    }
                }
            }

            updatePlayer(deltaTime) {
                const p = this.player;
                if (p.isDying) return;
                
                const speed = 7.5;
                const jumpPower = 18;
                const acceleration = 2.0;

                // Horizontal movement
                if (this.keys.ArrowLeft) {
                    p.vx = Math.max(p.vx - acceleration, -speed);
                } else if (this.keys.ArrowRight) {
                    p.vx = Math.min(p.vx + acceleration, speed);
                } else {
                    p.vx *= this.friction;
                }

                // Jumping
                if (this.keys.Space && (p.onGround || this.player.coyoteTime > 0) && p.canJump) {
                    p.vy = -jumpPower;
                    p.onGround = false;
                    p.canJump = false;
                    this.player.coyoteTime = 0;
                    this.audioManager.playSound('jump');
                }

                if (!this.keys.Space) {
                    p.canJump = true;
                }

                // Coyote time
                if (p.onGround) {
                    this.player.coyoteTime = 8;
                } else if (this.player.coyoteTime > 0) {
                    this.player.coyoteTime--;
                }

                // Gravity
                p.vy += this.gravity;
                if (p.vy > 16) p.vy = 16;

                // Variable jump height
                if (!this.keys.Space && p.vy < 0) {
                    p.vy *= 0.6;
                }

                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Platform collision
                p.onGround = false;
                this.entities.filter(e => e.type === 'platform').forEach(platform => {
                    if (this.collision(p, platform)) {
                        const overlapX = Math.min(p.x + p.width - platform.x, platform.x + platform.w - p.x);
                        const overlapY = Math.min(p.y + p.height - platform.y, platform.y + platform.h - p.y);

                        if (overlapY < overlapX) {
                            if (p.vy > 0 && p.y < platform.y) {
                                p.y = platform.y - p.height;
                                p.vy = 0;
                                p.onGround = true;
                            } else if (p.vy < 0 && p.y > platform.y) {
                                p.y = platform.y + platform.h;
                                p.vy = 0;
                            }
                        } else {
                            if (p.x < platform.x) {
                                p.x = platform.x - p.width;
                            } else {
                                p.x = platform.x + platform.w;
                            }
                            p.vx *= 0.3;
                        }
                    }
                });

                // World boundaries
                if (p.x < 0) {
                    p.x = 0;
                    p.vx = 0;
                }
                
                const effectiveWorldWidth = deviceInfo.isMobile ? this.worldWidth * 0.7 : this.worldWidth;
                if (p.x + p.width > effectiveWorldWidth) {
                    p.x = effectiveWorldWidth - p.width;
                    p.vx = 0;
                }

                // Death by falling
                if (p.y > 600) {
                    this.playerDie();
                }
            }

            updateEnemies(deltaTime) {
                const platforms = this.entities.filter(e => e.type === 'platform');
                
                this.entities.filter(e => e.type === 'enemy').forEach((enemy) => {
                    enemy.vy += this.gravity;
                    if (enemy.vy > 10) enemy.vy = 10;
                    
                    if (enemy.platformBound && enemy.currentPlatform) {
                        const platform = enemy.currentPlatform;
                        
                        const nextX = enemy.x + enemy.vx * 2;
                        const wouldFallOff = (nextX <= platform.x) || (nextX + enemy.w >= platform.x + platform.w);
                        
                        const atRangeLimit = Math.abs(enemy.x - enemy.startX) >= enemy.range;
                        
                        if (wouldFallOff || atRangeLimit) {
                            enemy.vx *= -1;
                        }
                        
                        enemy.x = Math.max(platform.x, Math.min(platform.x + platform.w - enemy.w, enemy.x + enemy.vx));
                        enemy.y = platform.y - enemy.h;
                        enemy.vy = 0;
                        enemy.onGround = true;
                    } else {
                        enemy.x += enemy.vx;
                        enemy.y += enemy.vy;
                        
                        enemy.onGround = false;
                        platforms.forEach(platform => {
                            if (this.collision(enemy, platform)) {
                                if (enemy.vy > 0 && enemy.y < platform.y) {
                                    enemy.y = platform.y - enemy.h;
                                    enemy.vy = 0;
                                    enemy.onGround = true;
                                    if (enemy.platformBound) {
                                        enemy.currentPlatform = platform;
                                    }
                                }
                            }
                        });
                        
                        if (enemy.x < 0 || enemy.x + enemy.w > this.worldWidth) {
                            enemy.vx *= -1;
                        }
                        
                        // Respawn enemies that fall
                        if (enemy.y > 700) {
                            enemy.x = enemy.startX;
                            enemy.y = enemy.startX - 100;
                            enemy.vy = 0;
                            enemy.vx = Math.abs(enemy.vx) * (Math.random() > 0.5 ? 1 : -1);
                        }
                    }
                });
            }

            updateCamera(deltaTime) {
                let viewportWidth = 800;
                if (deviceInfo.isMobile) {
                    viewportWidth = deviceInfo.screenWidth * 0.7;
                } else if (deviceInfo.isTablet) {
                    viewportWidth = deviceInfo.screenWidth * 0.8;
                }
                
                const effectiveWorldWidth = deviceInfo.isMobile ? this.worldWidth * 0.7 : this.worldWidth;
                const target = Math.max(0, Math.min(this.player.x - viewportWidth/2, effectiveWorldWidth - viewportWidth));
                this.camera.targetX = target;
                this.camera.x += (this.camera.targetX - this.camera.x) * 0.12;
            }

            checkCollisions() {
                const p = this.player;
                if (p.isDying) return;

                // Collectibles
                this.entities.filter(e => e.type === 'collectible' && !e.collected).forEach((crystal) => {
                    const distance = Math.sqrt(
                        Math.pow(p.x + p.width/2 - (crystal.x + crystal.w/2), 2) + 
                        Math.pow(p.y + p.height/2 - (crystal.y + crystal.h/2), 2)
                    );
                    
                    if (distance < 30) {
                        crystal.collected = true;
                        this.score += 100;
                        this.updateHUD();
                        this.showCollectEffect(crystal.x, crystal.y);
                        this.audioManager.playSound('collect');
                    }
                });

                // Enemies
                if (!p.invulnerable) {
                    this.entities.filter(e => e.type === 'enemy').forEach((enemy) => {
                        if (this.collision(p, enemy)) {
                            this.playerDie();
                        }
                    });
                }

                // Goal
                const goalEntity = this.entities.find(e => e.type === 'goal');
                if (goalEntity && this.collision(p, goalEntity)) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    
                    if (collected === total) {
                        this.levelComplete();
                    } else {
                        const now = Date.now();
                        if (now - this.lastGoalMessage > this.goalMessageCooldown) {
                            this.showMessage(`Raccogli tutti i cristalli! (${collected}/${total})`);
                            this.lastGoalMessage = now;
                        }
                    }
                }
            }

            showCollectEffect(x, y) {
                const effect = document.createElement('div');
                effect.style.cssText = `
                    position: absolute;
                    left: ${x - this.camera.x}px;
                    top: ${y}px;
                    width: 30px;
                    height: 30px;
                    background: radial-gradient(circle, var(--neon-green), transparent);
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    animation: collectEffect 0.5s ease-out forwards;
                `;
                
                document.body.appendChild(effect);
                setTimeout(() => effect.remove(), 500);
            }

            collision(a, b) {
                return a.x < b.x + b.w && 
                       a.x + a.width > b.x && 
                       a.y < b.y + b.h && 
                       a.y + a.height > b.y;
            }

            playerDie() {
                if (this.player.isDying || this.player.invulnerable) return;
                
                this.player.isDying = true;
                this.audioManager.playSound('death');
                
                this.showMessage(`üí• Colpito! Energia: ${this.player.energy - 1}/3`);
                
                setTimeout(() => {
                    this.player.energy--;
                    
                    if (this.player.energy <= 0) {
                        this.gameOver();
                    } else {
                        this.respawnPlayer();
                    }
                }, 800);
            }

            respawnPlayer() {
                this.player.x = 50;
                this.player.y = 400;
                this.player.vx = 0;
                this.player.vy = 0;
                this.player.isDying = false;
                this.player.invulnerable = true;
                this.player.invulnerabilityTime = 2000; // 2 seconds of invulnerability
                this.camera.x = 0;
                this.camera.targetX = 0;
                
                this.updateHUD();
            }

            levelComplete() {
                this.running = false;
                this.score += 1000 + (this.player.energy * 300);
                
                // Save progress
                this.progressManager.updateLevelProgress(this.currentLevel, this.score, true);
                
                this.audioManager.playSound('complete');
                this.story.showStory(this.currentLevel, 'outro');
            }

            processNextAction() {
                if (this.currentLevel === 3 || this.currentLevel === 5) {
                    this.showReward();
                } else if (this.currentLevel < this.maxLevels) {
                    this.nextLevel();
                } else {
                    this.showGameComplete();
                }
            }

            showReward() {
                const rewardCode = this.generateRewardCode();
                const discount = this.currentLevel === 3 ? '3%' : '5%';
                const minimum = this.currentLevel === 3 ? '150‚Ç¨' : '180‚Ç¨';

                // Save reward
                const progress = this.progressManager.loadProgress();
                if (!progress.unlockedRewards.includes(rewardCode)) {
                    progress.unlockedRewards.push(rewardCode);
                    this.progressManager.saveProgress(progress);
                }

                document.getElementById('overlayTitle').textContent = 'üéâ RICOMPENSA SBLOCCATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="background: linear-gradient(45deg, var(--neon-green), var(--neon-blue)); color: white; padding: 20px; border-radius: 12px; margin: 20px 0; font-family: 'Orbitron', monospace; font-size: 1.2rem; font-weight: 700; position: relative;">
                        <div id="rewardCode" style="user-select: all; -webkit-user-select: all; -moz-user-select: all;">${rewardCode}</div>
                        <button onclick="copyRewardCode('${rewardCode}')" style="
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            background: rgba(255,255,255,0.2);
                            border: 1px solid rgba(255,255,255,0.3);
                            color: white;
                            padding: 8px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-size: 0.8rem;
                            transition: all 0.3s ease;
                        ">
                            üìã Copia
                        </button>
                    </div>
                    <p style="font-size: 1.1rem; color: var(--neon-green); margin: 15px 0;">
                        <strong>‚ú® Sconto ${discount} su ordini sopra ${minimum} ‚ú®</strong>
                    </p>
                    <p style="font-size: 0.9rem; opacity: 0.8;">
                        üîí Salva questo codice! Verr√† accettato nel nostro store.
                    </p>
                    <p style="margin-top: 20px; color: var(--neon-blue);">
                        Punteggio: <strong>${this.score.toLocaleString()}</strong>
                    </p>
                `;
                
                document.getElementById('overlayButton').textContent = this.currentLevel < this.maxLevels ? '‚û°Ô∏è CONTINUA' : 'üè† TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    if (this.currentLevel < this.maxLevels) {
                        this.nextLevel();
                    } else {
                        this.showGameComplete();
                    }
                };
                
                this.showOverlay();
            }

            showGameComplete() {
                document.getElementById('overlayTitle').textContent = 'üëë MISSIONE COMPLETATA!';
                document.getElementById('overlayTitle').className = 'overlay-title success';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <h2 style="color: var(--neon-green); font-size: 1.5rem; margin-bottom: 20px;">
                            üéâ HAI SALVATO TUTTE LE DIMENSIONI! üéâ
                        </h2>
                        
                        <div style="background: var(--glass); border-radius: 15px; padding: 25px; margin: 20px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left;">
                                <div><strong style="color: var(--neon-blue);">üèÜ Esploratore:</strong><br>${this.player.name}</div>
                                <div><strong style="color: var(--neon-blue);">‚è±Ô∏è Tempo:</strong><br>${this.formatTime(this.gameTime)}</div>
                                <div><strong style="color: var(--neon-blue);">üíØ Punteggio:</strong><br>${this.score.toLocaleString()}</div>
                                <div><strong style="color: var(--neon-blue);">‚ö° Energia finale:</strong><br>${this.player.energy}/3</div>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; color: var(--neon-green); margin: 15px 0;">
                            üåå Tutte le dimensioni digitali sono state ripristinate!<br>
                            üéÆ Sei ufficialmente un Maestro Esploratore!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = 'üè† TORNA AL MENU';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.showScreen('mainMenu');
                };
                
                this.showOverlay();
                
                // Save final progress
                this.progressManager.updateLevelProgress(this.maxLevels, this.score, true);
            }

            gameOver() {
                this.running = false;
                
                document.getElementById('overlayTitle').textContent = 'üíÄ MISSIONE FALLITA';
                document.getElementById('overlayTitle').className = 'overlay-title danger';
                document.getElementById('overlayContent').innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <p style="font-size: 1.1rem; color: var(--neon-orange); margin-bottom: 20px;">
                            ‚ö° Le entit√† corrotte hanno vinto... per ora ‚ö°
                        </p>
                        
                        <div style="background: var(--glass); border-radius: 10px; padding: 20px; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>üéØ Livello raggiunto:</span>
                                <span style="color: var(--neon-blue);">${this.currentLevel}/${this.maxLevels}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>üíØ Punteggio finale:</span>
                                <span style="color: var(--neon-green);">${this.score.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 8px 0;">
                                <span>‚è±Ô∏è Tempo sopravvissuto:</span>
                                <span style="color: var(--neon-purple);">${this.formatTime(this.gameTime)}</span>
                            </div>
                        </div>
                        
                        <p style="font-size: 1rem; margin: 15px 0; color: var(--neon-blue);">
                            üí™ Non mollare! Le dimensioni hanno ancora bisogno di te!
                        </p>
                    </div>
                `;
                
                document.getElementById('overlayButton').textContent = 'üîÑ RIPROVA';
                document.getElementById('overlayButton').onclick = () => {
                    this.hideOverlay();
                    this.currentLevel = 1;
                    this.score = 0;
                    this.player.energy = this.player.maxEnergy;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.story.showStory(1, 'intro');
                };
                
                this.showOverlay();
                
                // Save game over progress
                this.progressManager.updateLevelProgress(this.currentLevel, this.score, false);
            }

            nextLevel() {
                this.currentLevel++;
                if (this.currentLevel <= this.maxLevels) {
                    this.story.showStory(this.currentLevel, 'intro');
                }
            }

            confirmExit() {
                if (confirm('Vuoi davvero tornare al menu? Il progresso andr√† perso.')) {
                    this.running = false;
                    this.isPaused = false;
                    this.state = 'menu';
                    document.body.classList.remove('game-active');
                    this.showScreen('mainMenu');
                }
            }

            generateRewardCode() {
                const prefix = this.currentLevel === 3 ? 'RETRO3' : 'RETRO5';
                const timestamp = Date.now().toString(36).toUpperCase();
                const random = Math.random().toString(36).substr(2, 4).toUpperCase();
                const playerHash = this.player.name.slice(0, 2).toUpperCase();
                return `${prefix}-${playerHash}${timestamp.slice(-3)}-${random}`;
            }

            render() {
                const world = document.getElementById('world');
                if (!world) return;
                
                world.style.transform = `translate3d(${-this.camera.x}px, 0, 0)`;
                
                const fragment = document.createDocumentFragment();
                
                // Player
                const playerEl = document.createElement('div');
                playerEl.className = 'player';
                
                if (Math.abs(this.player.vx) > 1 && !this.player.isDying) {
                    playerEl.classList.add('moving');
                }
                
                if (this.player.isDying) {
                    playerEl.classList.add('dying');
                } else if (this.player.invulnerable) {
                    playerEl.classList.add('invulnerable');
                }
                
                playerEl.style.cssText = `
                    left: ${this.player.x}px;
                    top: ${this.player.y}px;
                `;
                
                fragment.appendChild(playerEl);
                
                // Visible entities (performance optimization)
                const cameraLeft = this.camera.x - 100;
                const cameraRight = this.camera.x + 900;
                
                this.visibleEntities = this.entities.filter(entity => {
                    if (entity.type === 'collectible' && entity.collected) return false;
                    return entity.x + entity.w >= cameraLeft && entity.x <= cameraRight;
                });
                
                this.visibleEntities.forEach(entity => {
                    const el = document.createElement('div');
                    el.className = entity.type;
                    
                    if (entity.id) {
                        el.setAttribute('data-enemy-id', entity.id);
                    }
                    
                    el.style.cssText = `
                        left: ${entity.x}px;
                        top: ${entity.y}px;
                        width: ${entity.w}px;
                        height: ${entity.h}px;
                    `;
                    
                    // Boss enemy styling
                    if (entity.type === 'enemy' && entity.w > 30) {
                        el.style.background = 'linear-gradient(45deg, var(--neon-purple), var(--neon-orange))';
                        el.style.border = '2px solid var(--neon-purple)';
                        el.style.boxShadow = '0 0 30px var(--neon-purple)';
                    }
                    
                    fragment.appendChild(el);
                });
                
                world.innerHTML = '';
                world.appendChild(fragment);
            }

            updateHUD() {
                // Desktop HUD
                const updates = {
                    'hud-name': this.player.name,
                    'hud-level': this.currentLevel,
                    'hud-score': this.score.toLocaleString()
                };
                
                Object.entries(updates).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== String(value)) {
                        el.textContent = value;
                    }
                });
                
                this.updateEnergyDisplay();
                
                const hudCrystals = document.getElementById('hud-crystals');
                if (hudCrystals) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    const crystalText = `${collected}/${total}`;
                    if (hudCrystals.textContent !== crystalText) {
                        hudCrystals.textContent = crystalText;
                    }
                }

                this.updateMobileHUD();
            }

            updateMobileHUD() {
                const mobileUpdates = {
                    'mobile-player-name': this.player.name,
                    'mobile-player-level': this.currentLevel,
                    'mobile-score': this.score.toLocaleString(),
                    'mobile-energy': `${this.player.energy}/3`
                };
                
                Object.entries(mobileUpdates).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && el.textContent !== String(value)) {
                        el.textContent = value;
                    }
                });
                
                const mobileCrystals = document.getElementById('mobile-crystals');
                if (mobileCrystals) {
                    const collected = this.entities.filter(e => e.type === 'collectible' && e.collected).length;
                    const total = this.entities.filter(e => e.type === 'collectible').length;
                    const crystalText = `${collected}/${total}`;
                    if (mobileCrystals.textContent !== crystalText) {
                        mobileCrystals.textContent = crystalText;
                    }
                }
            }

            updateEnergyDisplay() {
                const energyBar = document.getElementById('energy-bar');
                if (!energyBar) return;
                
                const orbs = energyBar.querySelectorAll('.energy-orb');
                orbs.forEach((orb, index) => {
                    if (index < this.player.energy) {
                        orb.classList.remove('empty');
                    } else {
                        orb.classList.add('empty');
                    }
                });
            }

            updateTimer() {
                const time = this.formatTime(this.gameTime);
                const hudTime = document.getElementById('hud-time');
                if (hudTime && hudTime.textContent !== time) {
                    hudTime.textContent = time;
                }

                const mobileTime = document.getElementById('mobile-time');
                if (mobileTime && mobileTime.textContent !== time) {
                    mobileTime.textContent = time;
                }
            }

            formatTime(ms) {
                const seconds = Math.floor(ms / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            showScreen(screenId) {
                if (screenId === 'mainMenu') {
                    document.body.classList.remove('game-active');
                }
                
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                setTimeout(() => {
                    const screen = document.getElementById(screenId);
                    if (screen) screen.classList.add('active');
                }, 100);
                this.state = screenId === 'mainMenu' ? 'menu' : this.state;
            }

            showOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.add('active');
            }

            hideOverlay() {
                const overlay = document.getElementById('gameOverlay');
                if (overlay) overlay.classList.remove('active');
            }

            showMessage(text) {
                const message = document.createElement('div');
                message.className = 'enhanced-message';
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.style.animation = 'enhancedMessageSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.remove();
                        }
                    }, 400);
                }, 3000);
            }
        }

        // GAME MANAGER MIGLIORATO - Central hub for all game interactions
        class GameManager {
            constructor() {
                this.game = null;
                this.loadingManager = new LoadingManager();
                this.init();
            }

            async init() {
                try {
                    // Start loading
                    await this.loadingManager.start();
                    
                    this.game = new Game();
                    
                    this.setupGlobalEventListeners();
                    
                    console.log('üéÆ RetroAvia - The Dark Chronicles caricato con successo!');
                } catch (error) {
                    console.error('‚ùå Errore inizializzazione GameManager:', error);
                    showNotification('Errore di inizializzazione. Ricarica la pagina.');
                }
            }

            setupGlobalEventListeners() {
                // Context menu prevention
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                // Double tap zoom prevention
                let lastTouchEnd = 0;
                document.addEventListener('touchend', e => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Auto pause on visibility change
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.game && this.game.running) {
                        this.game.pauseGame();
                        this.game.showMessage('üîÑ Gioco automaticamente in pausa');
                    }
                });
                
                // Prevent accidental page leave
                window.addEventListener('beforeunload', e => {
                    if (this.game && this.game.running && this.game.state === 'playing') {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }

            startGame() {
                const nameInput = document.getElementById('playerName');
                if (!nameInput) return;
                
                const name = nameInput.value.trim();
                if (!name || name.length < 2) {
                    showNotification('Inserisci un nome di almeno 2 caratteri!');
                    nameInput.focus();
                    return;
                }
                if (name.length > 12) {
                    showNotification('Il nome deve essere massimo 12 caratteri!');
                    nameInput.focus();
                    return;
                }
                
                if (this.game) {
                    this.game.audioManager.playSound('button');
                    this.game.start(name);
                }
            }

            handleStoryAction() {
                if (this.game && this.game.story) {
                    this.game.audioManager.playSound('button');
                    this.game.story.hideStory();
                    
                    const storyTitle = document.getElementById('storyTitle').textContent;
                    if (storyTitle.includes('INIZIA MISSIONE') || storyTitle.includes('IL RISVEGLIO') || 
                        storyTitle.includes('LE ISOLE FLUTTUANTI') || storyTitle.includes('IL GUANTO DI SFIDA') || 
                        storyTitle.includes('PRECISIONE ASSOLUTA') || storyTitle.includes('LO SCONTRO FINALE')) {
                        this.game.startLevel();
                    } else {
                        this.game.processNextAction();
                    }
                }
            }

            pauseGame() {
                if (this.game) {
                    this.game.pauseGame();
                }
            }

            resumeGame() {
                if (this.game) {
                    this.game.resumeGame();
                }
            }

            restartLevel() {
                if (this.game) {
                    this.game.restartLevel();
                }
            }

            goHomeFromPause() {
                if (this.game) {
                    this.game.goHomeFromPause();
                }
            }

            goHome() {
                if (this.game && this.game.state === 'playing') {
                    this.game.confirmExit();
                } else if (this.game) {
                    this.game.showScreen('mainMenu');
                }
            }

            async toggleAudio() {
                if (this.game && this.game.audioManager) {
                    try {
                        await this.game.audioManager.toggle();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Errore toggle audio:', error);
                        showNotification('‚ùå Audio non disponibile su questo dispositivo');
                    }
                }
            }

            toggleQuality() {
                if (this.game && this.game.renderEngine) {
                    const currentMode = this.game.renderEngine.performanceMode;
                    const newMode = currentMode === 'high' ? 'low' : 'high';
                    this.game.renderEngine.setQualityMode(newMode);
                    
                    showNotification(`üéÆ Qualit√†: ${newMode === 'high' ? 'ALTA' : 'BASSA'}`);
                }
            }

            nextAction() {
                const overlayButton = document.getElementById('overlayButton');
                if (overlayButton && overlayButton.onclick) {
                    overlayButton.onclick();
                }
            }
        }

        // ====== INIZIALIZZAZIONE MIGLIORATA ======
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üì± DOM loaded - Inizializzazione...');
            
            // Rileva dispositivo immediatamente
            detectDevice();
            
            // Inizializza il Game Manager
            try {
                gameManager = new GameManager();
                window.gameManager = gameManager;
                console.log('‚úÖ Game Manager inizializzato con successo');
            } catch (error) {
                console.error('‚ùå Errore inizializzazione:', error);
                showNotification('Errore di inizializzazione. Ricarica la pagina.');
            }
            
            // Abilita debug se necessario
            if (window.location.search.includes('debug')) {
                document.body.classList.add('debug');
                console.log('üîß DEBUG MODE ATTIVATO');
            }
        });

        // Eventi resize e orientamento
        window.addEventListener('resize', () => {
            detectDevice();
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                detectDevice();
            }, 500);
        });

        // Safety initialization (fallback)
        setTimeout(() => {
            if (!gameManager) {
                console.log('‚ö° Safety initialization...');
                try {
                    gameManager = new GameManager();
                    window.gameManager = gameManager;
                } catch (error) {
                    console.error('‚ùå Safety initialization failed:', error);
                    showNotification('Errore critico. Ricarica la pagina.');
                }
            }
        }, 2000);
    </script>
</body>
</html>
